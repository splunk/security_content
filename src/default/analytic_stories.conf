[AWS Cross Account Activity]
category = Cloud Security
creation_date = 2018-06-04
data_models =
description = Track when a user assumes an IAM role in another AWS account to obtain cross-account access to services and resources in that account. Accessing new roles could be an indication of malicious activity.
id = 2f2f610a-d64d-48c2-b57c-967a2b49ab5a
version = 1.0
mappings = {"mitre_attack": ["Credential Access"], "cis20": ["CIS 16"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["DE.AE", "PR.DS", "PR.AC"]}
modification_date = 2018-11-02
reference = ["https://aws.amazon.com/blogs/security/aws-cloudtrail-now-tracks-cross-account-activity-to-its-origin/"]
providing_technologies = ["AWS", "Splunk Enterprise Security"]
detection_searches = ["ESCU - AWS Cross Account Activity From Previously Unseen Account - Rule"]
investigative_searches = ["ESCU - AWS Investigate User Activities By AccessKeyId", "ESCU - AWS Investigate User Activities By Source User"]
contextual_searches = ["ESCU - Get Notable History"]
support_searches = ["ESCU - Previously Seen AWS Cross Account Activity"]
narrative = Amazon Web Services (AWS) admins manage access to AWS resources and services across the enterprise using AWS's Identity and Access Management (IAM) functionality. IAM provides the ability to create and manage AWS users, groups, and roles-each with their own unique set of privileges and defined access to specific resources (such as EC2 instances, the AWS Management Console, API, or the command-line interface). Unlike conventional (human) users, IAM roles are assumable by anyone in the organization. They provide users with dynamically created temporary security credentials that expire within a set time period.\
\
Herein lies the rub. In between the time between when the temporary credentials are issued and when they expire is a period of opportunity, where a user could leverage the temporary credentials to wreak havoc-spin up or remove instances, create new users, elevate privileges, and other malicious activities-throughout the environment.\
\
This Analytic Story includes searches that will help you monitor your AWS CloudTrail logs for evidence of suspicious cross-account activity.  For example, while accessing multiple AWS accounts and roles may be perfectly valid behavior, it may be suspicious when an account requests privileges of an account it has not accessed in the past. After identifying suspicious activities, you can use the provided investigative searches to help you probe more deeply.

[AWS Cryptomining]
category = Cloud Security
creation_date = 2018-03-08
data_models =
description = Monitor your AWS EC2 instances for activities related to cryptojacking/cryptomining. New instances that originate from previously unseen regions, users who launch abnormally high numbers of instances, or EC2 instances started by previously unseen users are just a few examples of potentially malicious behavior.
id = ced74200-8465-4bc3-bd2c-9a782eec6750
version = 1.0
mappings = {"mitre_attack": ["Defense Evasion", "Execution"], "cis20": ["CIS 12", "CIS 13", "CIS 1"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["ID.AM", "DE.AE", "DE.DP"]}
modification_date = 2018-03-15
reference = ["https://d0.awsstatic.com/whitepapers/aws-security-best-practices.pdf"]
providing_technologies = ["AWS"]
detection_searches = ["ESCU - EC2 Instance Started In Previously Unseen Region - Rule", "ESCU - Abnormally High AWS Instances Launched by User - Rule", "ESCU - EC2 Instance Started With Previously Unseen Instance Type - Rule", "ESCU - EC2 Instance Started With Previously Unseen AMI - Rule", "ESCU - EC2 Instance Started With Previously Unseen User - Rule"]
contextual_searches = ["ESCU - Get EC2 Launch Details"]
support_searches = ["ESCU - Previously Seen AWS Regions", "ESCU - Previously Seen EC2 Launches By User", "ESCU - Previously Seen EC2 Instance Types", "ESCU - Previously Seen EC2 AMIs"]
narrative = Cryptomining is an intentionally difficult, resource-intensive business. Its complexity was designed into the process to ensure that the number of blocks mined each day would remain steady. So, it's par for the course that ambitious, but unscrupulous, miners make amassing the computing power of large enterprises--a practice known as cryptojacking--a top priority. \
\
Cryptojacking has attracted an increasing amount of media attention since its explosion in popularity in the fall of 2017. The attacks have moved from in-browser exploits and mobile phones to enterprise cloud services, such as Amazon Web Services (AWS). It's difficult to determine exactly how widespread the practice has become, since bad actors continually evolve their ability to escape detection, including employing unlisted endpoints, moderating their CPU usage, and hiding the mining pool's IP address behind a free CDN. \
\
When malicious miners appropriate a cloud instance, often spinning up hundreds of new instances, the costs can become astronomical for the account holder. So, it is critically important to monitor your systems for suspicious activities that could indicate that your network has been infiltrated. \
\
This Analytic Story is focused on detecting suspicious new instances in your EC2 environment to help prevent such a disaster. It contains detection searches that will detect when a previously unused instance type or AMI is used. It also contains support searches to build lookup files to ensure proper execution of the detection searches.

[AWS Network ACL Activity]
category = Cloud Security
creation_date = 2018-01-10
data_models =
description = Monitor your AWS network infrastructure for bad configurations and malicious activity. Investigative searches help you probe deeper, when the facts warrant it.
id = 2e8948a5-5239-406b-b56b-6c50ff268af4
version = 2.0
mappings = {"mitre_attack": ["Command and Control", "Exfiltration", "Persistence"], "cis20": ["CIS 11", "CIS 12"], "kill_chain_phases": ["Command and Control", "Actions on Objectives"], "nist": ["DE.CM", "DE.AE", "DE.DP", "PR.AC"]}
modification_date = 2018-05-21
reference = ["https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Appendix_NACLs.html", "https://aws.amazon.com/blogs/security/how-to-help-prepare-for-ddos-attacks-by-reducing-your-attack-surface/"]
providing_technologies = ["AWS", "Splunk Enterprise Security"]
detection_searches = ["ESCU - AWS Network Access Control List Created with All Open Ports - Rule", "ESCU - AWS Network Access Control List Deleted - Rule", "ESCU - Detect Spike in blocked Outbound Traffic from your AWS - Rule", "ESCU - Detect Spike in Network ACL Activity - Rule"]
investigative_searches = ["ESCU - AWS Investigate User Activities By ARN"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - AWS Network ACL Details from ID", "ESCU - AWS Network Interface details via resourceId"]
support_searches = ["ESCU - Baseline of blocked outbound traffic from AWS", "ESCU - Baseline of Network ACL Activity by ARN"]
narrative = AWS CloudTrail is an AWS service that helps you enable governance, compliance, and operational/risk auditing of your AWS account. Actions taken by a user, role, or an AWS service are recorded as events in CloudTrail. It is crucial for a company to monitor events and actions taken in the AWS Management Console, AWS Command Line Interface, and AWS SDKs and APIs to ensure that your servers are not vulnerable to attacks. This analytic story contains detection searches that leverage CloudTrail logs from AWS to check for bad configurations and malicious activity in your AWS network access controls.

[AWS Suspicious Provisioning Activities]
category = Cloud Security
creation_date = 2018-03-16
data_models =
description = Monitor your AWS provisioning activities for behaviors originating from unfamiliar or unusual locations. These behaviors may indicate that malicious activities are occurring somewhere within your network.
id = 3338b567-3804-4261-9889-cf0ca4753c7f
version = 1.0
mappings = {"cis20": ["CIS 1"], "nist": ["ID.AM"]}
modification_date = 2018-03-19
reference = ["https://d0.awsstatic.com/whitepapers/aws-security-best-practices.pdf"]
providing_technologies = ["AWS"]
detection_searches = ["ESCU - AWS Cloud Provisioning From Previously Unseen Country - Rule", "ESCU - AWS Cloud Provisioning From Previously Unseen Region - Rule", "ESCU - AWS Cloud Provisioning From Previously Unseen City - Rule", "ESCU - AWS Cloud Provisioning From Previously Unseen IP Address - Rule"]
investigative_searches = ["ESCU - Get All AWS Activity From City", "ESCU - Get All AWS Activity From Country", "ESCU - Get All AWS Activity From Region", "ESCU - Get All AWS Activity From IP Address"]
support_searches = ["ESCU - Previously Seen AWS Provisioning Activity Sources"]
narrative = Because most enterprise AWS activities originate from familiar geographic locations, monitoring for activity from unknown or unusual regions is an important security measure. This indicator can be especially useful in environments where it is impossible to whitelist specific IPs (because they vary).\
\
This Analytic Story was designed to provide you with flexibility in the precision you employ in specifying legitimate geographic regions. It can be as specific as an IP address or a city, or as broad as a region (think state) or an entire country. By determining how precise you want your geographical locations to be and monitoring for new locations that haven't previously accessed your environment, you can detect adversaries as they begin to probe your environment. Since there are legitimate reasons for activities from unfamiliar locations, this is not a standalone indicator. Nevertheless, location can be a relevant piece of information that you may wish to investigate further.

[AWS User Monitoring]
category = Cloud Security
creation_date = 2018-03-12
data_models =
description = Detect and investigate dormant user accounts for your AWS environment that have become active again. Because inactive and ad-hoc accounts are common attack targets, it's critical to enable governance within your environment.
id = 2e8948a5-5239-406b-b56b-6c50f1269af3
version = 1.0
mappings = {"mitre_attack": ["Credential Access", "Execution"], "kill_chain_phases": ["Actions on Objectives"], "cis20": ["CIS 16", "CIS 1"], "nist": ["ID.AM", "DE.CM", "DE.DP", "PR.AC"]}
modification_date = 2018-12-03
reference = ["https://d0.awsstatic.com/whitepapers/aws-security-best-practices.pdf", "https://blog.redlock.io/cryptojacking-tesla"]
providing_technologies = ["AWS", "Splunk Enterprise Security"]
detection_searches = ["ESCU - Detect AWS API Activities From Unapproved Accounts - Rule", "ESCU - Detect Spike in AWS API Activity - Rule", "ESCU - Detect new API calls from user roles - Rule", "ESCU - Detect Spike in Security Group Activity - Rule", "ESCU - Detect API activity from users without MFA - Rule"]
investigative_searches = ["ESCU - Investigate AWS User Activities by user field"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History"]
support_searches = ["ESCU - Create a list of approved AWS service accounts", "ESCU - Baseline of API Calls per User ARN", "ESCU - Previously seen API call per user roles in CloudTrail", "ESCU - Baseline of Security Group Activity by ARN"]
narrative = It seems obvious that it is critical to monitor and control the users who have access to your cloud infrastructure. Nevertheless, it's all too common for enterprises to lose track of ad-hoc accounts, leaving their servers vulnerable to attack. In fact, this was the very oversight that led to Tesla's cryptojacking attack in February, 2018.\
\
In addition to compromising the security of your data, when bad actors leverage your compute resources, it can incur monumental costs, since you will be billed for any new EC2 instances and increased bandwidth usage. \
\
Fortunately, you can leverage Amazon Web Services (AWS) CloudTrail--a tool that helps you enable governance, compliance, and risk auditing of your AWS account--to give you increased visibility into your user and resource activity by recording AWS Management Console actions and API calls. You can identify which users and accounts called AWS, the source IP address from which the calls were made, and when the calls occurred.\
\
The detection searches in this Analytic Story are designed to help you uncover AWS API activities from users not listed in the identity table, as well as similar activities from disabled accounts.

[Account Monitoring and Controls]
category = Best Practices
creation_date = 2017-08-05
data_models = ["Authentication", "Change_Analysis", "Identity_Management", "Risk"]
description = A common attack technique is to leverage user accounts to gain unauthorized access to the target's network. This Analytic Story minimizes opportunities for attack by helping you actively manage creation/use/dormancy/deletion--the lifecycle of system and application accounts.
id = 8892a655-6205-55f7-abba-06460e38c8ae
version = 1.0
mappings = {"mitre_attack": ["Valid Accounts"], "cis20": ["CIS 16"], "nist": ["PR.IP"]}
modification_date = 2018-01-05
reference = ["https://www.sans.org/media/critical-security-controls/critical-controls-poster-2016.pdf"]
providing_technologies = ["Active Directory", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "macOS"]
detection_searches = ["ESCU - Identify New User Accounts - Rule", "ESCU - Short Lived Windows Accounts - Rule", "ESCU - Detect Excessive User Account Lockouts - Rule", "ESCU - Detect Excessive Account Lockouts From Endpoint - Rule"]
investigative_searches = ["ESCU - Get Logon Rights Modifications For User", "ESCU - Get Logon Rights Modifications For Endpoint"]
contextual_searches = ["ESCU - Get Notable History", "ESCU - Get Notable Info", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Monitoring user accounts within your enterprise is a critical analytic function that helps ensure that credential and access policies/procedures are properly implemented and are being enforced. Proactive ad-hoc hunting, as well as routine monitoring, can ensure user or system accounts are not being abused by unauthorized individuals or processes. In the event of a network event or breach, user-authentication logs are a key resource in determining if or how an account might have been compromised or co-opted, leading to suspicious or malicious activity.

[Apache Struts Vulnerability]
category = Vulnerability
creation_date = 2017-03-14
data_models = ["Application_State", "Authentication", "Risk", "Web"]
description = Detect and investigate activities--such as unusually long `Content-Type` length, suspicious java classes and web servers executing suspicious processes--consistent with attempts to exploit Apache Struts vulnerabilities.
id = 2dcfd6a2-e7d2-4873-b6ba-adaf819d2a1e
version = 1.0
mappings = {"mitre_attack": ["Exploitation of Vulnerability", "Defense Evasion", "Execution", "System Information Discovery", "Discovery"], "cis20": ["CIS 18", "CIS 7", "CIS 4", "CIS 12", "CIS 3"], "kill_chain_phases": ["Delivery", "Actions on Objectives", "Exploitation"], "nist": ["ID.RA", "RS.MI", "PR.PT", "PR.IP", "DE.AE", "PR.MA", "DE.CM"]}
modification_date = 2018-12-06
reference = ["http://blog.talosintelligence.com/2017/03/apache-0-day-exploited.html", "https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/v3.2/dev/rules/REQUEST-944-APPLICATION-ATTACK-JAVA.conf"]
providing_technologies = ["Apache", "Bluecoat", "Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Unusually Long Content-Type Length - Rule", "ESCU - Web Servers Executing Suspicious Processes - Rule", "ESCU - Suspicious Java Classes - Rule"]
investigative_searches = ["ESCU - Investigate Suspicious Strings in HTTP Header", "ESCU - Investigate Web POSTs From src"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = In March of 2017, a remote code-execution vulnerability in the Jakarta Multipart parser in Apache Struts, a widely used open-source framework for creating Java web applications, was disclosed and assigned to CVE-2017-5638. About two months later, hackers exploited the flaw to carry out the world's <a href=https://www.usatoday.com/story/tech/2017/09/07/nations-biggest-hacks-and-data-breaches-millions/644311001/> 5th largest data breach</a>. The target, credit giant Equifax, <a href=https://money.cnn.com/2017/09/16/technology/equifax-breach-security-hole/index.html>told investigators</a> that it had become aware of the vulnerability two months before the attack. \
\
The exploit involved manipulating the `Content-Type HTTP` header to execute commands embedded in the header.\
\
This Analytic Story contains two different searches that help to identify activity that may be related to this issue. The first search looks for characteristics of the `Content-Type` header consistent with attempts to exploit the vulnerability. This should be a relatively pertinent indicator, as the `Content-Type` header is generally consistent and does not have a large degree of variation.\
\
The second search looks for the execution of various commands typically entered on the command shell when an attacker first lands on a system. These commands are not generally executed on web servers during the course of day-to-day operation, but they may be used when the system is undergoing maintenance or troubleshooting.\
\
First, it is helpful is to understand how often the notable event is generated, as well as the commonalities in some of these events. This may help determine whether this is a common occurrence that is of a lesser concern or a rare event that may require more extensive investigation. It can also help to understand whether the issue is restricted to a single user or system or is broader in scope.\
\
When looking at the target of the behavior illustrated by the event, you should note the sensitivity of the user and or/system to help determine the potential impact. It is also helpful to see what other events involving the target have occurred in the recent past. This can help tie different events together and give further situational awareness regarding the target.\
\
Various types of information for external systems should be reviewed and (potentially) collected if the incident is, indeed, judged to be malicious. Information like this can be useful in generating your own threat intelligence to create alerts in the future.\
\
Looking at the country, responsible party, and fully qualified domain names associated with the external IP address--as well as the registration information associated with those domain names, if they are frequently visited by others--can help you answer the question of "who," in regard to the external system. Answering that can help qualify the event and may serve useful for tracking. In addition, there are various sources that can provide some reputation information on the IP address or domain name, which can assist in determining if the event is malicious in nature. Finally, determining whether or not there are other events associated with the IP address may help connect some dots or show other events that should be brought into scope.\
\
Gathering various data elements on the system of interest can sometimes help quickly determine that something suspicious may be happening. Some of these items include determining who else may have recently logged into the system, whether any unusual scheduled tasks exist, whether the system is communicating on suspicious ports, whether there are modifications to sensitive registry keys, and whether there are any known vulnerabilities on the system. This information can often highlight other activity commonly seen in attack scenarios or give more information about how the system may have been targeted.\
\
When a specific service or application is targeted, it is often helpful to know the associated version to help determine whether or not it is vulnerable to a specific exploit.\
\
When it is suspected there is an attack targeting a web server, it is helpful to look at some of the behavior of the web service to see if there is evidence that the service has been compromised. Some indications of this might be network connections to external resources, the web service spawning child processes that are not associated with typical behavior, and whether the service wrote any files that might be malicious in nature.\
\
In the event that a suspicious file is found, we can review more information about it to help determine if it is, in fact, malicious. Identifying the file type, any processes that have the file open, what processes created and/or modified the file, and the number of systems that may have this file can help to determine if the file is malicious. Also, determining the file hash and checking it against reputation sources, such as VirusTotal, can sometimes quickly help determine whether it is malicious in nature.\
\
Often, a simple inspection of a suspect process name and path can tell you if the system has been compromised. For example, if `svchost.exe` is found running from a location other than `C:\Windows\System32`, it is likely something malicious designed to hide in plain sight when simply reviewing process names. Similarly, if the process itself seems legitimate, but the parent process is running from the temporary browser cache, there may be activity initiated via a compromised website the user visited.\
\
It can also be very helpful to examine various behaviors of the process of interest or the parent of the process that is of interest. For example, if it turns out that the process of interest is malicious, it would be good to see if the parent to that process spawned other processes that might also be worth further scrutiny. If a process is suspect, reviewing the network connections made around the time of the event and/or if the process spawned any child processes could be helpful in determining whether it is malicious or executing a malicious script.

[Asset Tracking]
category = Best Practices
creation_date = 2017-06-01
data_models = ["Authentication", "Identity_Management", "Network_Sessions", "Risk"]
description = Keep a careful inventory of every asset on your network to make it easier to detect rogue devices. Unauthorized/unmanaged devices could be an indication of malicious behavior that should be investigated further.
id = 91c676cf-0b23-438d-abee-f6335e1fce77
version = 1.0
mappings = {"mitre_attack": ["Defense Evasion"], "cis20": ["CIS 1"], "kill_chain_phases": ["Delivery", "Actions on Objectives", "Reconnaissance"], "nist": ["ID.AM", "PR.DS"]}
modification_date = 2017-11-01
reference = ["https://www.cisecurity.org/controls/inventory-of-authorized-and-unauthorized-devices/"]
providing_technologies = ["Bro", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Splunk Stream", "macOS"]
detection_searches = ["ESCU - Detect Unauthorized Assets by MAC address - Rule"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get First Occurrence and Last Occurrence of a MAC Address", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
support_searches = ["ESCU - Count of assets by category"]
narrative = This Analytic Story is designed to help you develop a better understanding of what authorized and unauthorized devices are part of your enterprise. This story can help you better categorize and classify assets, providing critical business context and awareness of their assets during an incident. Information derived from this Analytic Story can be used to better inform and support other analytic stories. For successful detection, you will need to leverage the Assets and Identity Framework from Enterprise Security to populate your known assets.

[Brand Monitoring]
category = Abuse
creation_date = 2017-06-01
data_models = ["Application_State", "Authentication", "Email", "Network_Resolution", "Risk", "Web"]
description = Detect and investigate activity that may indicate that an adversary is using faux domains to mislead users into interacting with malicious infrastructure. Monitor DNS, email, and web traffic for permutations of your brand name.
id = 91c676cf-0b23-438d-abee-f6335e1fce78
version = 1.0
mappings = {"mitre_attack": [], "cis20": ["CIS 7"], "kill_chain_phases": ["Delivery", "Actions on Objectives"], "nist": ["PR.IP"]}
modification_date = 2018-10-08
reference = ["https://blog.domaintools.com/tag/brand-monitor/", "https://securingtomorrow.mcafee.com/consumer/family-safety/what-is-typosquatting/", "https://blog.malwarebytes.com/cybercrime/2016/06/explained-typosquatting/"]
providing_technologies = ["Bluecoat", "Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Exchange", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Monitor DNS For Brand Abuse - Rule", "ESCU - Monitor Email For Brand Abuse - Rule", "ESCU - Monitor Web Traffic For Brand Abuse - Rule"]
investigative_searches = ["ESCU - Get Email Info", "ESCU - Get Emails From Specific Sender", "ESCU - Investigate Web Activity From Host", "ESCU - Get DNS Server History for a host", "ESCU - Get Process responsible for the DNS traffic"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
support_searches = ["ESCU - DNSTwist Domain Names"]
narrative = While you can educate your users and customers about the risks and threats posed by typosquatting, phishing, and corporate espionage, human error is a persistent fact of life. Of course, your adversaries are all too aware of this reality and will happily leverage it for nefarious purposes whenever possible&#51;phishing with lookalike addresses, embedding faux command-and-control domains in malware, and hosting malicious content on domains that closely mimic your corporate servers. This is where brand monitoring comes in.\
\
You can use our adaptation of `DNSTwist`, together with the support searches in this Analytic Story, to generate permutations of specified brands and external domains. Splunk can monitor email, DNS requests, and web traffic for these permutations and provide you with early warnings and situational awareness--powerful elements of an effective defense.\
\
Notable events will include IP addresses, URLs, and user data. Drilling down can provide you with even more actionable intelligence, including likely geographic information, contextual searches to help you scope the problem, and investigative searches.

[ColdRoot MacOS RAT]
category = Malware
creation_date = 2019-01-29
data_models = ["Alerts", "Authentication", "Network_Traffic", "Risk", "Vulnerabilities", "Web"]
description = Leverage searches that allow you to detect and investigate unusual activities that relate to the ColdRoot Remote Access Trojan that affects MacOS. An example of some of these activities are changing sensative binaries in the MacOS sub-system, detecting process names and executables associated with the RAT, detecting when a keyboard tab is installed on a MacOS machine and more.
id = ad7eb6e0-f06c-4781-b145-a42bd59c56e9
version = 1.0
mappings = {"mitre_attack": ["Command and Control", "Execution", "Collection", "Persistence"], "cis20": ["CIS 4", "CIS 8"], "kill_chain_phases": ["Command and Control", "Installation"], "nist": ["DE.CM", "DE.DP", "PR.PT"]}
modification_date = 2019-01-29
reference = ["https://www.intego.com/mac-security-blog/osxcoldroot-and-the-rat-invasion/", "https://objective-see.com/blog/blog_0x2A.html", "https://www.bleepingcomputer.com/news/security/coldroot-rat-still-undetectable-despite-being-uploaded-on-github-two-years-ago/"]
providing_technologies = ["Bluecoat", "Bro", "Linux", "Microsoft Windows", "Nessus", "OSquery", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "macOS"]
detection_searches = ["ESCU - Processes Tapping Keyboard Events - Rule", "ESCU - Osquery pack - ColdRoot detection - Rule"]
investigative_searches = ["ESCU - Investigate Network Traffic From src_ip", "ESCU - Investigate Web Activity From src_ip"]
contextual_searches = ["ESCU - Get Vulnerability Logs For Endpoint", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Conventional wisdom holds that Apple's MacOS operating system is significantly less vulnerable to attack than Windows machines. While that point is debatable, it is true that attacks against MacOS systems are much less common. However, this fact does not mean that Macs are impervious to breaches. To the contrary, research has shown that that Mac malware is increasing at an alarming rate. According to AV-test, in 2018, there were 86,865 new MacOS malware variants, up from 27,338 the year before&#151;a 31% increase. In contrast, the independent research firm found that new Windows malware had increased from 65.17M to 76.86M during that same period, less than half the rate of growth. The bottom line is that while the numbers look a lot smaller than Windows, it's definitely time to take Mac security more seriously.\
\
This Analytic Story addresses the ColdRoot remote access trojan (RAT), which was uploaded to Github in 2016, but was still escaping detection by the first quarter of 2018, when a new, more feature-rich variant was discovered masquerading as an Apple audio driver. Among other capabilities, the Pascal-based ColdRoot can heist passwords from users' keychains and remotely control infected machines without detection. In the initial report of his findings, Patrick Wardle, Chief Research Officer for Digita Security, explained that the new ColdRoot RAT could start and kill processes on the breached system, spawn new remote-desktop sessions, take screen captures and assemble them into a live stream of the victim's desktop, and more.\
\
Searches in this Analytic Story leverage the capabilities of OSquery to address ColdRoot detection from several different angles, such as looking for the existence of associated files and processes, and monitoring for signs of an installed keylogger.

[Collection and Staging]
category = Adversary Tactics
creation_date = 2018-01-08
data_models = ["Application_State", "Authentication", "Endpoint", "Network_Traffic", "Risk"]
description = Monitor for and investigate activities--such as suspicious writes to the Windows Recycling Bin or email servers sending high amounts of traffic to specific hosts, for example--that may indicate that an adversary is harvesting and exfiltrating sensitive data. 
id = 8e03c61e-13c4-4dcd-bfbe-5ce5a8dc031a
version = 1.0
mappings = {"mitre_attack": ["Commonly Used Port", "Data Staged", "Email Collection", "Collection"], "kill_chain_phases": ["Actions on Objectives"], "cis20": ["CIS 7", "CIS 8"], "nist": ["PR.PT", "DE.AE", "DE.CM"]}
modification_date = 2018-11-02
reference = ["https://attack.mitre.org/wiki/Collection", "https://attack.mitre.org/wiki/Technique/T1074"]
providing_technologies = ["Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Suspicious writes to windows Recycle Bin - Rule", "ESCU - Suspicious writes to System Volume Information - Rule", "ESCU - Email files written outside of the Outlook directory - Rule", "ESCU - Hosts receiving high volume of network traffic from email server - Rule", "ESCU - Email servers sending high volume traffic to hosts - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = A common adversary goal is to identify and exfiltrate data of value from a target organization. This data may include email conversations and addresses, confidential company information, links to network design/infrastructure, important dates, and so on.\
\
 Attacks are composed of three activities: identification, collection, and staging data for exfiltration. Identification typically involves scanning systems and observing user activity. Collection can involve the transfer of large amounts of data from various repositories. Staging/preparation includes moving data to a central location and compressing (and optionally encoding and/or encrypting) it. All of these activities provide opportunities for defenders to identify their presence. \
\
Use the searches to detect and monitor suspicious behavior related to these activities.

[Command and Control]
category = Adversary Tactics
creation_date = 2018-06-01
data_models = ["Application_State", "Authentication", "Network_Resolution", "Network_Traffic", "Risk"]
description = Detect and investigate tactics, techniques, and procedures leveraged by attackers to establish and operate command and control channels. Implants installed by attackers on compromised endpoints use these channels to receive instructions and send data back to the malicious operators.
id = 943773c6-c4de-4f38-89a8-0b92f98804d8
version = 1.0
mappings = {"mitre_attack": ["Command and Control", "Exfiltration Over Command and Control Channel", "Standard Non-Application Layer Protocol", "Commonly Used Port", "Exfiltration Over Alternative Protocol", "Exfiltration", "Standard Application Layer Protocol", "Defense Evasion"], "cis20": ["CIS 8", "CIS 9", "CIS 11", "CIS 12", "CIS 13", "CIS 3", "CIS 1"], "kill_chain_phases": ["Command and Control", "Actions on Objectives", "Delivery"], "nist": ["ID.AM", "PR.DS", "PR.IP", "PR.PT", "PR.AC", "DE.AE", "DE.CM"]}
modification_date = 2018-07-24
reference = ["https://attack.mitre.org/wiki/Command_and_Control", "https://searchsecurity.techtarget.com/feature/Command-and-control-servers-The-puppet-masters-that-govern-malware"]
providing_technologies = ["AWS", "Bluecoat", "Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Detect Large Outbound ICMP Packets - Rule", "ESCU - Protocol or Port Mismatch - Rule", "ESCU - Detection of DNS Tunnels - Rule", "ESCU - TOR Traffic - Rule", "ESCU - Prohibited Network Traffic Allowed - Rule", "ESCU - Clients Connecting to Multiple DNS Servers - Rule", "ESCU - DNS Query Length With High Standard Deviation - Rule", "ESCU - Detect hosts connecting to dynamic domain providers - Rule", "ESCU - Excessive DNS Failures - Rule", "ESCU - Detect Long DNS TXT Record Response - Rule", "ESCU - DNS Query Requests Resolved by Unauthorized DNS Servers - Rule", "ESCU - Detect Spike in blocked Outbound Traffic from your AWS - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Process responsible for the DNS traffic", "ESCU - Get DNS Server History for a host", "ESCU - Get DNS traffic ratio", "ESCU - Get All AWS Activity From IP Address", "ESCU - Get Process Information For Port Activity"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint", "ESCU - AWS Network Interface details via resourceId"]
support_searches = ["ESCU - Baseline of blocked outbound traffic from AWS"]
narrative = Threat actors typically architect and implement an infrastructure to use in various ways during the course of their attack campaigns. In some cases, they leverage this infrastructure for scanning and performing reconnaissance activities. In others, they may use this infrastructure to launch actual attacks. One of the most important functions of this infrastructure is to establish servers that will communicate with implants on compromised endpoints. These servers establish a command and control channel that is used to proxy data between the compromised endpoint and the attacker. These channels relay commands from the attacker to the compromised endpoint and the output of those commands back to the attacker.\
\
Because this communication is so critical for an adversary, they often use techniques designed to hide the true nature of the communications. There are many different techniques used to establish and communicate over these channels. This Analytic Story provides searches that look for a variety of the techniques used for these channels, as well as indications that these channels are active, by examining logs associated with border control devices and network-access control lists.

[Credential Dumping]
category = Adversary Tactics
creation_date = 2018-08-08
data_models = ["Application_State", "Authentication", "Endpoint", "Risk", "Web"]
description = Uncover activity consistent with credential dumping, a technique wherein attackers compromise systems and attempt to obtain and exfiltrate passwords. The threat actors use these pilfered credentials to further escalate privileges and spread throughout a target environment. The included searches in this Analytic Story are designed to identify attmpts to dump credentials.
id = 854d78bf-d0e2-4f4e-b05c-640905f86d7a
version = 1.0
mappings = {"mitre_attack": ["Execution", "Credential Access", "Credential Dumping", "PowerShell", "Scripting"], "cis20": ["CIS 8", "CIS 5", "CIS 3", "CIS 16"], "kill_chain_phases": ["Actions on Objectives", "Installation"], "nist": ["PR.PT", "DE.CM", "PR.AC", "PR.IP"]}
modification_date = 2018-12-03
reference = ["https://attack.mitre.org/wiki/Technique/T1003", "https://www.powershellempire.com/?page_id=112", "https://4iq.com/4iq-discovers-1-4-billion-clear-text-credentials-single-database/"]
providing_technologies = ["Bluecoat", "Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Attempt To Set Default PowerShell Execution Policy To Unrestricted - Rule", "ESCU - Attempted Credential Dump From Registry Via Reg.exe - Rule", "ESCU - Detect Mimikatz Via PowerShell And EventCode 4703 - Rule", "ESCU - Detect Mimikatz Via PowerShell And EventCode 4663 - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info", "ESCU - Investigate Web Activity From Host"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Credential dumping&#151;gathering credentials from a target system, often hashed or encrypted&#151;is a common attack technique. Even though the credentials may not be in plain text, an attacker can still exfiltrate the data and set to cracking it offline, on their own systems. The threat actors target a variety of sources to extract them, including the Security Accounts Manager (SAM), Local Security Authority (LSA), NTDS from Domain Controllers, or the Group Policy Preference (GPP) files.\
\
Once attackers obtain valid credentials, they use them to move throughout a target network with ease, discovering new systems and identifying assets of interest. Credentials obtained in this manner typically include those of privileged users, which may provide access to more sensitive information and system operations.\
\
The detection searches in this Analytic Story monitor for the process **reg.exe** with the "save" parameter, as well as for a target registry path that specifies a binary export of credentials from the registry. In addition, the analytics flag Windows events and activities associated with the use of Mimikatz functionality in Powershell Empire.

[DHS Report TA18-074A]
category = Malware
creation_date = 2018-03-19
data_models = ["Application_State", "Authentication", "Endpoint", "Network_Traffic", "Risk"]
description = Monitor for suspicious activities associated with DHS Technical Alert US-CERT TA18-074A. Some of the activities that adversaries used in these compromises included spearfishing attacks, malware, watering-hole domains, many and more.
id = 0c016e5c-88be-4e2c-8c6c-c2b55b4fb4ef
version = 2.0
mappings = {"mitre_attack": ["New Service", "Modify Registry", "AppInit DLLs", "Modify Existing Service", "Commonly Used Port", "Authentication Package", "Command-Line Interface", "Scheduled Task", "Disabling Security Tools", "Lateral Movement", "Credential Access", "Registry Run Keys / Start Folder", "Valid Accounts", "Scripting", "Privilege Escalation", "Defense Evasion", "Execution", "PowerShell", "Persistence"], "cis20": ["CIS 8", "CIS 7", "CIS 12", "CIS 5", "CIS 2", "CIS 3", "CIS 16"], "kill_chain_phases": ["Command and Control", "Actions on Objectives", "Installation"], "nist": ["ID.AM", "PR.DS", "PR.IP", "PR.PT", "PR.AC", "PR.AT", "DE.CM", "DE.AE"]}
modification_date = 2018-12-03
reference = ["https://www.us-cert.gov/ncas/alerts/TA18-074A"]
providing_technologies = ["Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - SMB Traffic Spike - Rule", "ESCU - Processes launching netsh - Rule", "ESCU - Suspicious Reg.exe Process - Rule", "ESCU - Sc.exe Manipulating Windows Services - Rule", "ESCU - Registry Keys Used For Persistence - Rule", "ESCU - Create local admin accounts using net.exe - Rule", "ESCU - Single Letter Process On Endpoint - Rule", "ESCU - Scheduled Task Name Used by Dragonfly Threat Actors - Rule", "ESCU - Malicious PowerShell Process - Execution Policy Bypass - Rule", "ESCU - Detect Outbound SMB Traffic - Rule", "ESCU - Detect New Local Admin account - Rule", "ESCU - Detect PsExec With accepteula Flag - Rule", "ESCU - First time seen command line argument - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
support_searches = ["ESCU - Previously seen command line arguments"]
narrative = The frequency of nation-state cyber attacks has increased significantly over the last decade. Employing numerous tactics and techniques, these attacks continue to escalate in complexity. \
\
There is a wide range of motivations for these state-sponsored hacks, including stealing valuable corporate, military, or diplomatic data&#1151;all of which could confer advantages in various arenas. They may also target critical infrastructure. \
\
One joint Technical Alert (TA) issued by the Department of Homeland and the FBI in mid-March of 2018 attributed some cyber activity targeting utility infrastructure to operatives sponsored by the Russian government. The hackers executed spearfishing attacks, installed malware, employed watering-hole domains, and more. While they caused no physical damage, the attacks provoked fears that a nation-state could turn off water, redirect power, or compromise a nuclear power plant.\
\
Suspicious activities--spikes in SMB traffic, processes that launch netsh (to modify the network configuration), suspicious registry modifications, and many more--may all be events you may wish to investigate further. While the use of these technique may be an indication that a nation-state actor is attempting to compromise your environment, it is important to note that these techniques are often employed by other groups, as well.

[DNS Amplification Attacks]
category = Abuse
creation_date = 2016-08-24
data_models = ["Network_Resolution", "Risk"]
description = DNS poses a serious threat as a Denial of Service (DOS) amplifier, if it responds to `ANY` queries. This Analytic Story can help you detect attackers who may be abusing your company's DNS infrastructure to launch amplification attacks, causing Denial of Service to other victims.
id = e8afd39e-3294-11e6-b39d-a45e60c6700
version = 1.0
mappings = {"cis20": ["CIS 11", "CIS 12"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["PR.PT", "DE.AE", "PR.IP"]}
modification_date = 2017-10-19
reference = ["https://www.us-cert.gov/ncas/alerts/TA13-088A", "https://deepthought.isc.org/article/AA-00897/0/What-is-a-DNS-Amplification-Attack.html"]
providing_technologies = ["Bro", "Splunk Enterprise Security", "Splunk Stream"]
detection_searches = ["ESCU - Large Volume of DNS ANY Queries - Rule"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = The Domain Name System (DNS) is the protocol used to map domain names to IP addresses. It has been proven to work very well for its intended function. However if DNS is misconfigured, servers can be abused by attackers to levy amplification or redirection attacks against victims. Because DNS responses to `ANY` queries are so much larger than the queries themselves--and can be made with a UDP packet, which does not require a handshake--attackers can spoof the source address of the packet and cause much more data to be sent to the victim than if they sent the traffic themselves. The `ANY` requests are will be larger than normal DNS server requests, due to the fact that the server provides significant details, such as MX records and associated IP addresses. A large volume of this traffic can result in a DOS on the victim's machine. This misconfiguration leads to two possible victims, the first being the DNS servers participating in an attack and the other being the hosts that are the targets of the DOS attack.\
\
The search in this story can help you to detect if attackers are abusing your company's DNS infrastructure to launch DNS amplification attacks causing Denial of Service to other victims.

[Data Protection]
category = Abuse
creation_date = 2017-06-01
data_models = ["Application_State", "Authentication", "Change_Analysis", "Network_Resolution", "Risk"]
description = Fortify your data-protection arsenal--while continuing to ensure data confidentiality and integrity--with searches that monitor for and help you investigate possible signs of data exfiltration.
id = 91c676cf-0b23-438d-abee-f6335e1fce33
version = 1.0
mappings = {"mitre_attack": ["Commonly Used Port", "Exfiltration", "Exfiltration Over Command and Control Channel", "Defense Evasion", "Command and Control"], "cis20": ["CIS 12", "CIS 13", "CIS 8"], "kill_chain_phases": ["Command and Control", "Actions on Objectives", "Installation"], "nist": ["PR.PT", "PR.DS", "DE.CM", "DE.AE"]}
modification_date = 2018-07-24
reference = ["https://www.cisecurity.org/controls/data-protection/", "https://www.sans.org/reading-room/whitepapers/dns/splunk-detect-dns-tunneling-37022", "https://umbrella.cisco.com/blog/2013/04/15/on-the-trail-of-malicious-dynamic-dns-domains/"]
providing_technologies = ["Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Detection of DNS Tunnels - Rule", "ESCU - Detect USB device insertion - Rule", "ESCU - Detect hosts connecting to dynamic domain providers - Rule"]
investigative_searches = ["ESCU - Get DNS Server History for a host", "ESCU - Get Process responsible for the DNS traffic"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Attackers can leverage a variety of resources to compromise or exfiltrate enterprise data. Common exfiltration techniques include remote-access channels via low-risk, high-payoff active-collections operations and close-access operations using insiders and removable media. While this Analytic Story is not a comprehensive listing of all the methods by which attackers can exfiltrate data, it provides a useful starting point.

[Disabling Security Tools]
category = Adversary Tactics
creation_date = 2018-04-09
data_models = ["Application_State", "Authentication", "Endpoint", "Risk"]
description = Looks for activities and techniques associated with the disabling of security tools on a Windows system, such as suspicious `reg.exe` processes, processes launching netsh, and many others.
id = fcc27099-46a0-46b0-a271-5c7dab56b6f1
version = 1.0
mappings = {"mitre_attack": ["New Service", "Modify Registry", "Modify Existing Service", "Command-Line Interface", "Disabling Security Tools", "Privilege Escalation", "Defense Evasion", "Execution", "Persistence"], "cis20": ["CIS 5", "CIS 3", "CIS 8"], "kill_chain_phases": ["Actions on Objectives", "Installation"], "nist": ["PR.PT", "PR.AT", "DE.CM", "PR.AC", "PR.IP"]}
modification_date = 2018-11-15
reference = ["https://attack.mitre.org/wiki/Technique/T1089", "https://blog.malwarebytes.com/cybercrime/2015/11/vonteera-adware-uses-certificates-to-disable-anti-malware/", "https://www.operationblockbuster.com/wp-content/uploads/2016/02/Operation-Blockbuster-Tools-Report.pdf"]
providing_technologies = ["Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Sc.exe Manipulating Windows Services - Rule", "ESCU - Suspicious Reg.exe Process - Rule", "ESCU - Processes launching netsh - Rule", "ESCU - Attempt To Stop Security Service - Rule", "ESCU - Attempt To Add Certificate To Untrusted Store - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Attackers employ a variety of tactics in order to avoid detection and operate without barriers. This often involves modifying the configuration of security tools to get around them or explicitly disabling them to prevent them from running. This Analytic Story includes searches that look for activity consistent with attackers attempting to disable various security mechanisms. Such activity may involve monitoring for suspicious registry activity, as this is where much of the configuration for Windows and various other programs reside, or explicitly attempting to shut down security-related services. Other times, attackers attempt various tricks to prevent specific programs from running, such as adding the certificates with which the security tools are signed to a blacklist (which would prevent them from running).

[Dynamic DNS]
category = Malware
creation_date = 2017-11-21
data_models = ["Application_State", "Authentication", "Network_Resolution", "Network_Traffic", "Risk", "Web"]
description = Detect and investigate hosts in your environment that may be communicating with dynamic domain providers. Attackers may leverage these services to help them avoid firewall blocks and blacklists.
id = 8169f17b-ef68-4b59-aae8-5869073014e1
version = 2.0
mappings = {"mitre_attack": ["Command and Control", "Exfiltration Over Command and Control Channel", "Commonly Used Port", "Exfiltration", "Defense Evasion", "Web Service"], "cis20": ["CIS 7", "CIS 12", "CIS 13", "CIS 8"], "kill_chain_phases": ["Command and Control", "Actions on Objectives"], "nist": ["PR.DS", "DE.DP", "PR.IP", "PR.PT", "DE.AE", "DE.CM"]}
modification_date = 2018-09-06
reference = ["https://www.fireeye.com/blog/threat-research/2017/09/apt33-insights-into-iranian-cyber-espionage.html", "https://umbrella.cisco.com/blog/2013/04/15/on-the-trail-of-malicious-dynamic-dns-domains/", "http://www.noip.com/blog/2014/07/11/dynamic-dns-can-use-2/", "https://www.splunk.com/blog/2015/08/04/detecting-dynamic-dns-domains-in-splunk.html"]
providing_technologies = ["Bluecoat", "Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Detect hosts connecting to dynamic domain providers - Rule", "ESCU - Detect web traffic to dynamic domain providers - Rule"]
investigative_searches = ["ESCU - Get DNS Server History for a host", "ESCU - Get DNS traffic ratio", "ESCU - Get Process responsible for the DNS traffic", "ESCU - Investigate Web Activity From src_ip"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Dynamic DNS services (DDNS) are legitimate low-cost or free services that allow users to rapidly update domain resolutions to IP infrastructure. While their usage can be benign, malicious actors can abuse DDNS to host harmful payloads or interactive-command-and-control infrastructure. These attackers will manually update or automate domain resolution changes by routing dynamic domains to IP addresses that circumvent firewall blocks and blacklists and frustrate a network defender's analytic and investigative processes. These searches will look for DNS queries made from within your infrastructure to suspicious dynamic domains and then investigate more deeply, when appropriate. While this list of top-level dynamic domains is not exhaustive, it can be dynamically updated as new suspicious dynamic domains are identified.

[Emotet Malware (TA18-201A)]
category = Malware
creation_date = 2018-09-11
data_models = ["Application_State", "Authentication", "Email", "Endpoint", "Network_Traffic", "Risk", "Web"]
description = Detect rarely used executables, specific registry paths that may confer malware survivability and persistence, instances where cmd.exe is used to launch script interpreters, and other indicators that the Emotet financial malware has compromised your environment.
id = bb9f5ed2-916e-4364-bb6d-91c310efcf52
version = 1.0
mappings = {"mitre_attack": ["Third-party Software", "AppInit DLLs", "Commonly Used Port", "Command-Line Interface", "Registry Run Keys / Start Folder", "Persistence", "Defense Evasion", "Execution", "Authentication Package", "Account Discovery"], "cis20": ["CIS 7", "CIS 12", "CIS 2", "CIS 3", "CIS 8"], "kill_chain_phases": ["Exploitation", "Delivery", "Installation", "Command and Control", "Actions on Objectives"], "nist": ["ID.AM", "PR.DS", "PR.IP", "PR.PT", "DE.AE", "DE.CM"]}
modification_date = 2018-12-03
reference = ["https://www.us-cert.gov/ncas/alerts/TA18-201A", "https://www.first.org/resources/papers/conf2017/Advanced-Incident-Detection-and-Threat-Hunting-using-Sysmon-and-Splunk.pdf", "https://www.vkremez.com/2017/05/emotet-banking-trojan-malware-analysis.html"]
providing_technologies = ["Bluecoat", "Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Exchange", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Detect Rare Executables - Rule", "ESCU - Registry Keys Used For Persistence - Rule", "ESCU - Detect Use of cmd.exe to Launch Script Interpreters - Rule", "ESCU - Prohibited Software On Endpoint - Rule", "ESCU - SMB Traffic Spike - Rule", "ESCU - Suspicious Email Attachment Extensions - Rule", "ESCU - Email Attachments With Lots Of Spaces - Rule", "ESCU - Detection of tools built by NirSoft - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info", "ESCU - Investigate Web Activity From Host"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = The trojan downloader known as Emotet first surfaced in 2014, when it was discovered targeting the banking industry to steal credentials. However, according to a joint technical alert (TA) issued by three government agencies (https://www.us-cert.gov/ncas/alerts/TA18-201A), Emotet has evolved far beyond those beginnings to become what a ThreatPost article called a threat-delivery service(see https://threatpost.com/emotet-malware-evolves-beyond-banking-to-threat-delivery-service/134342/).  For example, in early 2018, Emotet was found to be using its loader function to spread the Quakbot and Ransomware variants. \
\
According to the TA, the the malware continues to be among the most costly and destructive malware affecting the private and public sectors. Researchers have linked it to the threat group Mealybug, which has also been on the security communitys radar since 2014.\
\
The searches in this Analytic Story will help you find executables that are rarely used in your environment, specific registry paths that malware often uses to ensure survivability and persistence, instances where cmd.exe is used to launch script interpreters, and other indicators that Emotet or other malware has compromised your environment. 

[Hidden Cobra Malware]
category = Malware
creation_date = 2018-06-14
data_models = ["Application_State", "Authentication", "Email", "Endpoint", "Network_Resolution", "Network_Traffic", "Risk"]
description = Monitor for and investigate activities, including the creation or deletion of hidden shares and file writes, that may be evidence of infiltration by North Korean government-sponsored cybercriminals. Details of this activity were reported in DHS Report TA-18-149A.
id = baf7580b-d4b4-4774-8173-7d198e9da335
version = 2.0
mappings = {"mitre_attack": ["Command and Control", "Commonly Used Port", "Command-Line Interface", "Exfiltration", "Credential Access", "Scripting", "Lateral Movement", "Execution", "Remote Desktop Protocol", "Persistence"], "cis20": ["CIS 16", "CIS 12", "CIS 3", "CIS 8", "CIS 9"], "kill_chain_phases": ["Command and Control", "Actions on Objectives"], "nist": ["PR.PT", "DE.AE", "DE.CM", "PR.AC", "PR.IP"]}
modification_date = 2018-11-15
reference = ["https://www.us-cert.gov/HIDDEN-COBRA-North-Korean-Malicious-Cyber-Activity", "https://www.operationblockbuster.com/wp-content/uploads/2016/02/Operation-Blockbuster-Destructive-Malware-Report.pdf"]
providing_technologies = ["Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Exchange", "Microsoft Windows", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - SMB Traffic Spike - Rule", "ESCU - First time seen command line argument - Rule", "ESCU - Detect Outbound SMB Traffic - Rule", "ESCU - Remote Desktop Network Traffic - Rule", "ESCU - Remote Desktop Process Running On System - Rule", "ESCU - DNS Query Length With High Standard Deviation - Rule", "ESCU - Create or delete hidden shares using net.exe - Rule", "ESCU - Suspicious File Write - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info", "ESCU - Get Outbound Emails to Hidden Cobra Threat Actors"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
support_searches = ["ESCU - Previously seen command line arguments"]
narrative = North Korea's government-sponsored "cyber army" has been slowly building momentum and gaining sophistication over the last 15 years or so. As a result, the group's activity, which the US government refers to as "Hidden Cobra," has surreptitiously crept onto the collective radar as a preeminent global threat.\
\
These state-sponsored actors are thought to be responsible for everything from a hack on a South Korean nuclear plant to an attack on Sony in anticipation of its release of the movie "The Interview" at the end of 2014. They're also notorious for cyberespionage. In recent years, the group seems to be focused on financial crimes, such as cryptojacking.\
\
In June of 2018, The Department of Homeland Security, together with the FBI and other U.S. government partners, issued Technical Alert (TA-18-149A) to advise the public about two variants of North Korean malware. One variant, dubbed "Joanap," is a multi-stage peer-to-peer botnet that allows North Korean state actors to exfiltrate data, download and execute secondary payloads, and initialize proxy communications. The other variant, "Brambul," is a Windows32 SMB worm that is dropped into a victim network. When executed, the malware attempts to spread laterally within a victim's local subnet, connecting via the SMB protocol and initiating brute-force password attacks. It reports details to the Hidden Cobra actors via email, so they can use the information for secondary remote operations.\
\
Among other searches in this Analytic Story is a detection search that looks for the creation or deletion of hidden shares, such as, "adnim$," which the Hidden Cobra malware creates on the target system. Another looks for the creation of three malicious files associated with the malware. You can also use a search in this story to investigate activity that indicates that malware is sending email back to the attackers.

[Host Redirection]
category = Abuse
creation_date = 2017-06-18
data_models = ["Application_State", "Authentication", "Endpoint", "Risk", "Web"]
description = Detect evidence of tactics used to redirect traffic from a host to a destination other than the one intended--potentially one that is part of an adversary's attack infrastructure. An example is redirecting communications regarding patches and updates or misleading users into visiting a malicious website.
id = 2e8948a5-5239-406b-b56b-6c50fe268af4
version = 1.0
mappings = {"mitre_attack": ["Command and Control", "Exfiltration"], "cis20": ["CIS 12", "CIS 3", "CIS 8"], "kill_chain_phases": ["Command and Control"], "nist": ["PR.PT", "DE.AE", "DE.CM", "PR.AC", "PR.IP"]}
modification_date = 2018-11-02
reference = ["https://blog.malwarebytes.com/cybercrime/2016/09/hosts-file-hijacks/"]
providing_technologies = ["Bluecoat", "Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Windows hosts file modification - Rule"]
investigative_searches = ["ESCU - Investigate Web Activity From Host", "ESCU - Get DNS Server History for a host", "ESCU - Get Process responsible for the DNS traffic"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Attackers will often attempt to manipulate client communications for nefarious purposes. In some cases, an attacker may endeavor to modify a local host file to redirect communications with resources (such as antivirus or system-update services) to prevent clients from receiving patches or updates. In other cases, an attacker might use this tactic to have the client connect to a site that looks like the intended site, but instead installs malware or collects information from the victim. Additionally, an attacker may redirect a victim in order to execute a MITM attack and observe communications.

[JBoss Vulnerability]
category = Vulnerability
creation_date = 2016-10-04
data_models = ["Authentication", "Risk", "Web"]
description = In March of 2016, adversaries were seen using JexBoss--an open-source utility used for testing and exploiting JBoss application servers. These searches help detect evidence of these attacks, such as network connections to external resources or web services spawning atypical child processes, among others.
id = 1f5294cb-b85f-4c2d-9c58-ffcf248f52bd
version = 1.0
mappings = {"mitre_attack": ["Exploitation of Vulnerability", "Defense Evasion", "System Information Discovery", "Discovery"], "cis20": ["CIS 18", "CIS 12", "CIS 4"], "kill_chain_phases": ["Delivery", "Reconnaissance"], "nist": ["ID.RA", "PR.IP", "PR.PT", "DE.AE", "PR.MA", "DE.CM"]}
modification_date = 2017-11-01
reference = ["http://www.deependresearch.org/2016/04/jboss-exploits-view-from-victim.html"]
providing_technologies = ["Apache", "Bro", "Linux", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "macOS"]
detection_searches = ["ESCU - Detect malicious requests to exploit JBoss servers - Rule", "ESCU - Detect attackers scanning for vulnerable JBoss servers - Rule"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = This Analytic Story looks for probing and exploitation attempts targeting JBoss application servers. While the vulnerabilities associated with this story are rather dated, they were leveraged in a spring 2016 campaign in connection with the Samsam ransomware variant. Incidents involving this ransomware are unique, in that they begin with attacks against vulnerable services, rather than the phishing or drive-by attacks more common with ransomware. In this case, vulnerable JBoss applications appear to be the target of choice.\
\
It is helpful to understand how often a notable event generated by this story occurs, as well as the commonalities between some of these events, both of which may provide clues about whether this is a common occurrence of minimal concern or a rare event that may require more extensive investigation. It may also help to understand whether the issue is restricted to a single user/system or whether it is broader in scope.\
\
When looking at the target of the behavior uncovered by the event, you should note the sensitivity of the user and or/system to help determine the potential impact. It is also helpful to identify other recent events involving the target. This can help tie different events together and give further situational awareness regarding the target host.\
\
Various types of information for external systems should be reviewed and, potentially, collected if the incident is, indeed, judged to be malicious. This data may be useful for generating your own threat intelligence, so you can create future alerts.\
\
The following factors may assist you in determining whether the event is malicious: \
\
1. Country of origin\
\
1. Responsible party\
\
1. Fully qualified domain names associated with the external IP address\
\
1. Registration of fully qualified domain names associated with external IP address Determining whether it is a dynamic domain frequently visited by others and/or how third parties categorize it can also help you qualify and understand the event and possible motivation for the attack. In addition, there are various sources that may provide reputation information on the IP address or domain name, which can assist you in determining whether the event is malicious in nature. Finally, determining whether there are other events associated with the IP address may help connect data points or expose other historic events that might be brought back into scope.\
\
Gathering various data on the system of interest can sometimes help quickly determine whether something suspicious is happening. Some of these items include determining who else may have logged into the system recently, whether any unusual scheduled tasks exist, whether the system is communicating on suspicious ports, whether there are modifications to sensitive registry keys, and/or whether there are any known vulnerabilities on the system. This information can often highlight other activity commonly seen in attack scenarios or give more information about how the system may have been targeted.\
\
When a specific service or application is targeted, it is often helpful to know the associated version, to help determine whether it is vulnerable to a specific exploit.\
\
If you suspect an attack targeting a web server, it is helpful to look at some of the behavior of the web service to see if there is evidence that the service has been compromised. Some indications of this might be network connections to external resources, the web service spawning child processes that are not associated with typical behavior, and whether the service wrote any files that might be malicious in nature.\
\
If a suspicious file is found, we can review more information about it to help determine if it is, in fact, malicious. Identifying the file type, any processes that opened the file, the processes that may have created and/or modified the file, and how many other systems potentially have this file can you determine whether the file is malicious. Also, determining the file hash and checking it against reputation sources, such as VirusTotal, can sometimes help you quickly determine if it is malicious in nature.\
\
Often, a simple inspection of a suspect process name and path can tell you if the system has been compromised. For example, if svchost.exe is found running from a location other than `C:\Windows\System32`, it is likely something malicious designed to hide in plain sight when simply reviewing process names. \
\
It can also be helpful to examine various behaviors of and the parent of the process of interest. For example, if it turns out the process of interest is malicious, it would be good to see whether the parent process spawned other processes that might also warrant further scrutiny. If a process is suspect, a review of the network connections made around the time of the event and noting whether the process has spawned any child processes could be helpful in determining whether it is malicious or executing a malicious script.

[Lateral Movement]
category = Adversary Tactics
creation_date = 2016-09-13
data_models = ["Application_State", "Authentication", "Endpoint", "Network_Traffic", "Risk"]
description = Detect and investigate tactics, techniques, and procedures around how attackers move laterally within the enterprise. Because lateral movement can expose the adversary to detection, it should be an important focus for security analysts.
id = 399d65dc-1f08-499b-a259-aad9051f38ad
version = 1.0
mappings = {"mitre_attack": ["Commonly Used Port", "Scheduled Task", "Remote Services", "Pass the Hash", "Lateral Movement", "Defense Evasion", "Execution", "Remote Desktop Protocol", "Persistence"], "cis20": ["CIS 8", "CIS 5", "CIS 3", "CIS 16", "CIS 9"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["PR.IP", "PR.PT", "PR.AC", "DE.AE", "DE.CM", "PR.AT"]}
modification_date = 2018-11-02
reference = ["https://www.binarydefense.com/bds/reliably-detecting-pass-the-hash-through-event-log-analysis/", "https://www.fireeye.com/blog/executive-perspective/2015/08/malware_lateral_move.html"]
providing_technologies = ["Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Schtasks scheduling job on remote system - Rule", "ESCU - Remote Desktop Process Running On System - Rule", "ESCU - Remote Desktop Network Traffic - Rule", "ESCU - Detect Activity Related to Pass the Hash Attacks - Rule", "ESCU - Remote Registry Key modifications - Rule"]
investigative_searches = ["ESCU - Get Process Info"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
support_searches = ["ESCU - Identify Systems Using Remote Desktop", "ESCU - Identify Systems Creating Remote Desktop Traffic", "ESCU - Identify Systems Receiving Remote Desktop Traffic"]
narrative = Once attackers gain a foothold within an enterprise, they will seek to expand their accesses and leverage techniques that facilitate lateral movement. Attackers will often spend quite a bit of time and effort moving laterally. Because lateral movement renders an attacker the most vulnerable to detection, it's an excellent focus for detection and investigation.\
\
Indications of lateral movement can include the abuse of system utilities (such as `psexec.exe`), unauthorized use of remote desktop services, `file/admin$` shares, WMI, PowerShell, pass-the-hash, or the abuse of scheduled tasks. Organizations must be extra vigilant in detecting lateral movement techniques and look for suspicious activity in and around high-value strategic network assets, such as Active Directory, which are often considered the primary target or "crown jewels" to a persistent threat actor.\
\
An adversary can use lateral movement for multiple purposes, including remote execution of tools, pivoting to additional systems, obtaining access to specific information or files, access to additional credentials, exfiltrating data, or delivering a secondary effect. Adversaries may use legitimate credentials alongside inherent network and operating-system functionality to remotely connect to other systems and remain under the radar of network defenders.\
\
If there is evidence of lateral movement, it is imperative for analysts to collect evidence of the associated offending hosts. For example, an attacker might leverage host A to gain access to host B. From there, the attacker may try to move laterally to host C. In this example, the analyst should gather as much information as possible from all three hosts. \
\
 It is also important to collect authentication logs for each host, to ensure that the offending accounts are well-documented. Analysts should account for all processes to ensure that the attackers did not install unauthorized software.

[Malicious PowerShell]
category = Adversary Tactics
creation_date = 2016-09-18
data_models = ["Application_State", "Authentication", "Endpoint", "Risk"]
description = Attackers are finding stealthy ways "live off the land," leveraging utilities and tools that come standard on the endpoint--such as PowerShell--to achieve their goals without downloading binary files. These searches can help you detect and investigate PowerShell command-line options that may be indicative of malicious intent.
id = 2c8ff66e-0b57-42af-8ad7-912438a403fc
version = 4.0
mappings = {"mitre_attack": ["Execution", "PowerShell", "Scripting"], "cis20": ["CIS 7", "CIS 3", "CIS 8"], "kill_chain_phases": ["Command and Control", "Actions on Objectives", "Installation"], "nist": ["PR.PT", "DE.CM", "PR.IP"]}
modification_date = 2018-12-03
reference = ["https://blogs.mcafee.com/mcafee-labs/malware-employs-powershell-to-infect-systems/", "https://www.crowdstrike.com/blog/bears-midst-intrusion-democratic-national-committee/"]
providing_technologies = ["Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Malicious PowerShell Process - Connect To Internet With Hidden Window - Rule", "ESCU - Malicious PowerShell Process - Encoded Command - Rule", "ESCU - Malicious PowerShell Process - Multiple Suspicious Command-Line Arguments - Rule", "ESCU - Malicious PowerShell Process With Obfuscation Techniques - Rule", "ESCU - Attempt To Set Default PowerShell Execution Policy To Unrestricted - Rule"]
investigative_searches = ["ESCU - Get Process Info"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = The searches in this Analytic Story monitor for parameters often used for malicious purposes. It is helpful to understand how often the notable events generated by this story occur, as well as the commonalities between some of these events. These factors may provide clues about whether this is a common occurrence of minimal concern or a rare event that may require more extensive investigation. Likewise, it is important to determine whether the issue is restricted to a single user/system or is broader in scope.\
\
The following factors may assist you in determining whether the event is malicious: \
\
1. Country of origin\
\
1. Responsible party\
\
1. Fully qualified domain names associated with the external IP address\
\
1. Registration of fully qualified domain names associated with external IP addressDetermining whether it is a dynamic domain frequently visited by others and/or how third parties categorize it can also help you answer some questions surrounding the attacker and details related to the external system. In addition, there are various sources--such as VirusTotal&#151; that can provide some reputation information on the IP address or domain name, which can assist in determining whether the event is malicious. Finally, determining whether there are other events associated with the IP address may help connect data points or show other events that should be brought into scope.\
\
Gathering data on the system of interest can sometimes help you quickly determine whether something suspicious is happening. Some of these items include finding out who else may have recently logged into the system, whether any unusual scheduled tasks exist, whether the system is communicating on suspicious ports, whether there are modifications to sensitive registry keys, and whether there are any known vulnerabilities on the system. This information can often highlight other activity commonly seen in attack scenarios or give more information about how the system may have been targeted.\
\
Often, a simple inspection of the process name and path can tell you if the system has been compromised. For example, if `svchost.exe` is found running from a location other than `C:\Windows\System32`, it is likely something malicious designed to hide in plain sight when cursorily reviewing process names. Similarly, if the process itself seems legitimate, but the parent process is running from the temporary browser cache, that could be indicative of activity initiated via a compromised website a user visited.\
\
It can also be very helpful to examine various behaviors of the process of interest or the parent of the process of interest. For example, if it turns out the process of interest is malicious, it would be good to see if the parent to that process spawned other processes that might be worth further scrutiny. If a process is suspect, a review of the network connections made in and around the time of the event and/or whether the process spawned any child processes could be helpful, as well.\
\
In the event a system is suspected of having been compromised via a malicious website, we suggest reviewing the browsing activity from that system around the time of the event. If categories are given for the URLs visited, that can help you zero in on possible malicious sites.

[Monitor Backup Solution]
category = Best Practices
creation_date = 2017-06-15
data_models = ["Risk"]
description = Address common concerns when monitoring your backup processes. These searches can help you reduce risks from ransomware, device theft, or denial of physical access to a host by backing up data on endpoints.
id = abe807c7-1eb6-4304-ac32-6e7aacdb891d
version = 1.0
mappings = {"cis20": ["CIS 10"], "nist": ["PR.IP"]}
modification_date = 2017-10-19
reference = ["https://www.carbonblack.com/2016/03/04/tracking-locky-ransomware-using-carbon-black/"]
providing_technologies = ["Netbackup", "Splunk Enterprise Security"]
detection_searches = ["ESCU - Unsuccessful Netbackup backups - Rule", "ESCU - Extended Period Without Successful Netbackup Backups - Rule"]
investigative_searches = ["ESCU - All backup logs for host"]
contextual_searches = ["ESCU - Get Notable History", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
support_searches = ["ESCU - Monitor Successful Backups", "ESCU - Monitor Unsuccessful Backups"]
narrative = Having backups is a standard best practice that helps ensure continuity of business operations.  Having mature backup processes can also help you reduce the risks of many security-related incidents and streamline your response processes. The detection searches in this Analytic Story will help you identify systems that have backup failures, as well as systems that have not been backed up for an extended period of time. The story will also return the notable event history and all of the backup logs for an endpoint.

[Monitor for Unauthorized Software]
category = Best Practices
creation_date = 2017-06-26
data_models = ["Application_State", "Authentication", "Endpoint", "Risk", "Web"]
description = Identify and investigate prohibited/unauthorized software or processes that may be concealing malicious behavior within your environment. 
id = 8892a655-6205-43f7-abba-06460e38c8ae
version = 1.0
mappings = {"mitre_attack": ["Execution"], "cis20": ["CIS 2"], "kill_chain_phases": ["Command and Control", "Actions on Objectives", "Installation"], "nist": ["ID.AM", "PR.DS"]}
modification_date = 2017-11-09
reference = ["https://www.crowdstrike.com/blog/bears-midst-intrusion-democratic-national-committee/"]
providing_technologies = ["Bluecoat", "Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Prohibited Software On Endpoint - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Investigate Web Activity From Host"]
contextual_searches = ["ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
support_searches = ["ESCU - Add Prohibited Processes to Enterprise Security"]
narrative = It is critical to identify unauthorized software and processes running on enterprise endpoints and determine whether they are likely to be malicious. This Analytic Story requires the user to populate the Interesting Processes table within Enterprise Security with prohibited processes. An included support search will augment this data, adding information on processes thought to be malicious. This search requires data from endpoint detection-and-response solutions, endpoint data sources (such as Sysmon), or Windows Event Logs--assuming that the Active Directory administrator has enabled process tracking within the System Event Audit Logs.\
\
It is important to investigate any software identified as suspicious, in order to understand how it was installed or executed. Analyzing authentication logs or any historic notable events might elicit additional investigative leads of interest. For best results, schedule the search to run every two weeks. 

[Monitor for Updates]
category = Best Practices
creation_date = 2017-08-15
data_models = ["Authentication", "Risk", "Updates"]
description = Monitor your enterprise to ensure that your endpoints are being patched and updated. Adversaries notoriously exploit known vulnerabilities that could be mitigated by applying routine security patches.
id = 9ef8d677-7b52-4213-a038-99cfc7acc2d8
version = 1.0
mappings = {"cis20": ["CIS 18"], "nist": ["PR.PT", "PR.MA"]}
modification_date = 2017-11-01
reference = ["https://learn.cisecurity.org/20-controls-download"]
providing_technologies = ["Linux", "Microsoft Windows", "Splunk Enterprise Security", "macOS"]
detection_searches = ["ESCU - No Windows Updates in a time frame - Rule"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = It is a common best practice to ensure that endpoints are being patched and updated in a timely manner, in order to reduce the risk of compromise via a publicly disclosed vulnerability. Timely application of updates/patches is important to eliminate known vulnerabilities that may be exploited by various threat actors.\
\
Searches in this analytic story are designed to help analysts monitor endpoints for system patches and/or updates. This helps analysts identify any systems that are not successfully updated in a timely matter.\
\
Microsoft releases updates for Windows systems on a monthly cadence. They should be installed as soon as possible after following internal testing and validation procedures. Patches and updates for other systems or applications are typically released as needed.

[Netsh Abuse]
category = Abuse
creation_date = 2017-01-04
data_models = ["Application_State", "Authentication", "Endpoint", "Risk", "Web"]
description = Detect activities and various techniques associated with the abuse of `netsh.exe`, which can disable local firewall settings or set up a remote connection to a host from an infected system.
id = 2b1800dd-92f9-47ec-a981-fdf1351e5f65
version = 1.0
mappings = {"mitre_attack": ["Disabling Security Tools", "Defense Evasion", "Execution", "Command-Line Interface", "Persistence"], "cis20": ["CIS 8"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["PR.PT", "DE.CM"]}
modification_date = 2018-11-02
reference = ["https://technet.microsoft.com/library/bb490939.aspx", "https://htmlpreview.github.io/?https://github.com/MatthewDemaske/blogbackup/blob/master/netshell.html", "http://blog.jpcert.or.jp/2016/01/windows-commands-abused-by-attackers.html"]
providing_technologies = ["Bluecoat", "Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Processes created by netsh - Rule", "ESCU - Processes launching netsh - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info", "ESCU - Investigate Web Activity From Host"]
contextual_searches = ["ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = It is a common practice for attackers of all types to leverage native Windows tools and functionality to execute commands for malicious reasons. One such tool on Windows OS is `netsh.exe`,a command-line scripting utility that allows you to--either locally or remotely--display or modify the network configuration of a computer that is currently running. `Netsh.exe` can be used to discover and disable local firewall settings. It can also be used to set up a remote connection to a host from an infected system.\
\
To get started, run the detection search to identify parent processes of `netsh.exe`.

[Orangeworm Attack Group]
category = Malware
creation_date = 2018-06-14
data_models = ["Application_State", "Authentication", "Risk", "Web"]
description = Detect activities and various techniques associated with the Orangeworm Attack Group, a group that frequently targets the healthcare industry.
id = bb9f5ed2-916e-4364-bb6d-97c370efcf52
version = 2.0
mappings = {"mitre_attack": ["New Service", "Modify Existing Service", "Command-Line Interface", "Disabling Security Tools", "Scripting", "Privilege Escalation", "Defense Evasion", "Execution", "Persistence"], "cis20": ["CIS 5", "CIS 2", "CIS 3", "CIS 8", "CIS 9"], "kill_chain_phases": ["Command and Control", "Actions on Objectives", "Installation"], "nist": ["ID.AM", "PR.DS", "PR.IP", "PR.PT", "PR.AC", "PR.AT", "DE.CM", "DE.AE"]}
modification_date = 2018-08-01
reference = ["https://www.symantec.com/blogs/threat-intelligence/orangeworm-targets-healthcare-us-europe-asia", "https://www.infosecurity-magazine.com/news/healthcare-targeted-by-hacker/"]
providing_technologies = ["Bluecoat", "Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - First time seen command line argument - Rule", "ESCU - Sc.exe Manipulating Windows Services - Rule", "ESCU - First Time Seen Running Windows Service - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info", "ESCU - Investigate Web Activity From Host"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
support_searches = ["ESCU - Previously seen command line arguments", "ESCU - Previously Seen Running Windows Services"]
narrative = In May of 2018, the attack group Orangeworm was implicated for installing a custom backdoor called Trojan.Kwampirs within large international healthcare corporations in the United States, Europe, and Asia. This malware provides the attackers with remote access to the target system, decrypting and extracting a copy of its main DLL payload from its resource section. Before writing the payload to disk, it inserts a randomly generated string into the middle of the decrypted payload in an attempt to evade hash-based detections.\
\
Awareness of the Orangeworm group first surfaced in January, 2015. It has conducted targeted attacks against related industries, as well, such as pharmaceuticals and healthcare IT solution providers.\
\
Although the group's motivation is unknown, its goal may be stealing patient information to sell on the black market. Another possible explanation is corporate espionage. \
\
Healthcare may be a promising target, because it is notoriously behind in technology, often using older operating systems and neglecting to patch computers. Even so, the group was able to evade detection for a full three years. Sources say that the malware spread quickly within the target networks, infecting computers used to control medical devices, such as MRI and X-ray machines.\
\
This Analytic Story is designed to help you detect and investigate suspicious activities that may be indicative of an Orangeworm attack. One detection search looks for command-line arguments. Another monitors for uses of sc.exe, a non-essential Windows file that can manipulate Windows services. One of the investigative searches helps you get more information on web hosts that you suspect have been compromised.

[Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns]
category = Adversary Tactics
creation_date = 2018-07-24
data_models = ["Application_State", "Authentication", "Endpoint", "Risk"]
description = Monitor your environment for suspicious behaviors that resemble the techniques employed by the MUDCARP threat group.
id = 988C59C5-0A1C-45B6-A555-0C62276E327E
version = 1.0
mappings = {"mitre_attack": ["AppInit DLLs", "Command-Line Interface", "Registry Run Keys / Start Folder", "Persistence", "Authentication Package", "Execution", "PowerShell", "Scripting"], "cis20": ["CIS 7", "CIS 3", "CIS 8"], "kill_chain_phases": ["Command and Control", "Actions on Objectives"], "nist": ["PR.PT", "DE.AE", "DE.CM", "PR.IP"]}
modification_date = 2018-12-03
reference = ["https://intelgraph.idefense.com/#/node/threat_group/view/29fbec10-8cc8-4662-8362-2c24c1eeb74c", "https://intelgraph.idefense.com/#/node/intelligence_alert/view/62bb3669-9386-4264-b51a-59876cf50ffe", "http://blog.amossys.fr/badflick-is-not-so-bad.html"]
providing_technologies = ["Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - First time seen command line argument - Rule", "ESCU - Registry Keys Used For Persistence - Rule", "ESCU - Malicious PowerShell Process - Connect To Internet With Hidden Window - Rule", "ESCU - Unusually Long Command Line - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
support_searches = ["ESCU - Previously seen command line arguments"]
narrative = This story was created as a joint effort between iDefense and Splunk.\
\
iDefense analysts have recently discovered a Windows executable file that, upon execution, spoofs a decryption tool and then drops a file that appears to be the custom-built javascript backdoor, "Orz," which is associated with the threat actors known as MUDCARP (as well as "temp.Periscope" and "Leviathan"). The file is executed using Wscript.\
\
The MUDCARP techniques include the use of the compressed-folders module from Microsoft, zipfldr.dll, with RouteTheCall export to run the malicious process or command. After a successful reboot, the malware is made persistent by a manipulating `[HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run]'help'='c:\\windows\\system32\\rundll32.exe c:\\windows\\system32\\zipfldr.dll,RouteTheCall c:\\programdata\\winapp.exe'`. Though this technique is not exclusive to MUDCARP, it has been spotted in the group's arsenal of advanced techniques seen in the wild.\
\
This Analytic Story searches for evidence of tactics, techniques, and procedures (TTPs) that allow for the use of a endpoint detection-and-response (EDR) bypass technique to mask the true parent of a malicious process. It can also be set as a registry key for further sandbox evasion and to allow the malware to launch only after reboot.\
\
If behavioral searches included in this story yield positive hits, iDefense recommends conducting IOC searches for the following:\
\
\
\
1. www.chemscalere[.]com\
\
1. chemscalere[.]com\
\
1. about.chemscalere[.]com\
\
1. autoconfig.chemscalere[.]com\
\
1. autodiscover.chemscalere[.]com\
\
1. catalog.chemscalere[.]com\
\
1. cpanel.chemscalere[.]com\
\
1. db.chemscalere[.]com\
\
1. ftp.chemscalere[.]com\
\
1. mail.chemscalere[.]com\
\
1. news.chemscalere[.]com\
\
1. update.chemscalere[.]com\
\
1. webmail.chemscalere[.]com\
\
1. www.candlelightparty[.]org\
\
1. candlelightparty[.]org\
\
1. newapp.freshasianews[.]comIn addition, iDefense also recommends that organizations review their environments for activity related to the following hashes:\
\
\
\
1. cd195ee448a3657b5c2c2d13e9c7a2e2\
\
1. b43ad826fe6928245d3c02b648296b43\
\
1. 889a9b52566448231f112a5ce9b5dfaf\
\
1. b8ec65dab97cdef3cd256cc4753f0c54\
\
1. 04d83cd3813698de28cfbba326d7647c

[Prohibited Traffic Allowed or Protocol Mismatch]
category = Best Practices
creation_date = 2017-04-18
data_models = ["Application_State", "Authentication", "Network_Resolution", "Network_Traffic", "Risk"]
description = Detect instances of prohibited network traffic allowed in the environment, as well as protocols running on non-standard ports. Both of these types of behaviors typically violate policy and can be leveraged by attackers.
id = 6d13121c-90f3-446d-8ac3-27efbbc65218
version = 1.0
mappings = {"mitre_attack": ["Command and Control", "Exfiltration Over Command and Control Channel", "Commonly Used Port", "Exfiltration Over Alternative Protocol", "Exfiltration", "Defense Evasion"], "cis20": ["CIS 12", "CIS 13", "CIS 8", "CIS 9"], "kill_chain_phases": ["Command and Control", "Actions on Objectives", "Delivery"], "nist": ["PR.PT", "DE.AE", "DE.CM", "PR.AC", "PR.DS"]}
modification_date = 2018-07-24
reference = ["http://www.novetta.com/2015/02/advanced-methods-to-detect-advanced-cyber-attacks-protocol-abuse/"]
providing_technologies = ["Bluecoat", "Bro", "Linux", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "macOS"]
detection_searches = ["ESCU - TOR Traffic - Rule", "ESCU - Prohibited Network Traffic Allowed - Rule", "ESCU - Protocol or Port Mismatch - Rule", "ESCU - Detect hosts connecting to dynamic domain providers - Rule"]
investigative_searches = ["ESCU - Get Process Information For Port Activity"]
contextual_searches = ["ESCU - Get Notable History", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
support_searches = ["ESCU - Count of Unique IPs Connecting to Ports"]
narrative = A traditional security best practice is to control the ports, protocols, and services allowed within your environment. By limiting the services and protocols to those explicitly approved by policy, administrators can minimize the attack surface. The combined effect allows both network defenders and security controls to focus and not be mired in superfluous traffic or data types. Looking for deviations to policy can identify attacker activity that abuses services and protocols to run on alternate or non-standard ports in the attempt to avoid detection or frustrate forensic analysts.

[Ransomware]
category = Malware
creation_date = 2017-07-24
data_models = ["Application_State", "Authentication", "Endpoint", "Network_Traffic", "Risk", "Updates", "Vulnerabilities", "Web"]
description = Leverage searches that allow you to detect and investigate unusual activities that might relate to ransomware--spikes in SMB traffic, suspicious wevtutil usage, the presence of common ransomware extensions, and system processes run from unexpected locations, and many others.
id = cf309d0d-d4aa-4fbb-963d-1e79febd3756
version = 1.0
mappings = {"mitre_attack": ["Command and Control", "Windows Management Instrumentation", "Masquerading", "Commonly Used Port", "Indicator Removal on Host", "Exfiltration Over Alternative Protocol", "Scheduled Task", "Exfiltration", "Registry Run Keys / Start Folder", "AppInit DLLs", "Lateral Movement", "Defense Evasion", "Execution", "Authentication Package", "Persistence"], "cis20": ["CIS 10", "CIS 8", "CIS 9", "CIS 6", "CIS 12", "CIS 5", "CIS 3"], "kill_chain_phases": ["Command and Control", "Actions on Objectives", "Delivery"], "nist": ["DE.DP", "PR.IP", "PR.PT", "PR.AC", "DE.AE", "DE.CM", "PR.AT"]}
modification_date = 2018-12-03
reference = ["https://www.symantec.com/connect/blogs/what-you-need-know-about-wannacry-ransomware", "https://www.carbonblack.com/2017/06/28/carbon-black-threat-research-technical-analysis-petya-notpetya-ransomware/", "https://www.splunk.com/blog/2017/06/27/closing-the-detection-to-mitigation-gap-or-to-petya-or-notpetya-whocares-.html"]
providing_technologies = ["Bluecoat", "Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Nessus", "Netbackup", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Windows Event Log Cleared - Rule", "ESCU - Suspicious wevtutil Usage - Rule", "ESCU - USN Journal Deletion - Rule", "ESCU - Deleting Shadow Copies - Rule", "ESCU - Spike in File Writes - Rule", "ESCU - Prohibited Network Traffic Allowed - Rule", "ESCU - SMB Traffic Spike - Rule", "ESCU - Common Ransomware Extensions - Rule", "ESCU - Common Ransomware Notes - Rule", "ESCU - System Processes Run From Unexpected Locations - Rule", "ESCU - Remote Process Instantiation via WMI - Rule", "ESCU - TOR Traffic - Rule", "ESCU - Registry Keys Used For Persistence - Rule", "ESCU - Unusually Long Command Line - Rule", "ESCU - Scheduled tasks used in BadRabbit ransomware - Rule", "ESCU - Schtasks used for forcing a reboot - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Process Information For Port Activity", "ESCU - Investigate Web Activity From Host", "ESCU - Get Parent Process Info"]
contextual_searches = ["ESCU - Get Backup Logs For Endpoint", "ESCU - Get Update Logs For Endpoint", "ESCU - Get Vulnerability Logs For Endpoint", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
support_searches = ["ESCU - Monitor Successful Backups", "ESCU - Monitor Unsuccessful Backups", "ESCU - Windows Updates Install Failures", "ESCU - Windows Updates Install Successes"]
narrative = Ransomware is an ever-present risk to the enterprise, wherein an infected host encrypts business-critical data, holding it hostage until the victim pays the attacker a ransom. There are many types and varieties of ransomware that can affect an enterprise. Attackers can deploy ransomware to enterprises through spearphishing campaigns and driveby downloads, as well as through traditional remote service-based exploitation. In the case of the WannaCry campaign, there was self-propagating wormable functionality that was used to maximize infection. Fortunately, organizations can apply several techniques--such as those in this Analytic Story--to detect and or mitigate the effects of ransomware.

[Router & Infrastructure Security]
category = Best Practices
creation_date = 2017-06-01
data_models = ["Authentication", "Risk"]
description = Validate the security configuration of network infrastructure and verify that only authorized users and systems are accessing critical assets. Core routing and switching infrastructure are common strategic targets for attackers.
id = 91c676cf-0b23-438d-abee-f6335e177e77
version = 1.0
mappings = {"cis20": ["CIS 11"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["PR.PT", "PR.AC", "PR.IP"]}
modification_date = 2017-11-01
reference = ["https://www.fireeye.com/blog/executive-perspective/2015/09/the_new_route_toper.html", "https://www.cisco.com/c/en/us/about/security-center/event-response/synful-knock.html"]
providing_technologies = ["Active Directory", "Linux", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "macOS"]
detection_searches = ["ESCU - Detect New Login Attempts to Routers - Rule"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Networking devices, such as routers and switches, are often overlooked as resources that attackers will leverage to subvert an enterprise. Advanced threats actors have shown a proclivity to target these critical assets as a means to siphon and redirect network traffic, flash backdoored operating systems, and implement cryptographic weakened algorithms to more easily decrypt network traffic.\
\
This Analytic Story helps you gain a better understanding of how your network devices are interacting with your hosts. By compromising your network devices, attackers can obtain direct access to the company's internal infrastructure&#151; effectively increasing the attack surface and accessing private services/data.

[SQL Injection]
category = Adversary Tactics
creation_date = 2016-09-13
data_models = ["Authentication", "Risk", "Web"]
description = Use the searches in this Analytic Story to help you detect structured query language (SQL) injection attempts characterized by long URLs that contain malicious parameters.
id = 4f6632f5-449c-4686-80df-57625f59bab3
version = 1.0
mappings = {"mitre_attack": ["Exploitation of Vulnerability", "Commonly Used Port", "Defense Evasion", "Execution"], "cis20": ["CIS 18", "CIS 4", "CIS 13"], "kill_chain_phases": ["Delivery"], "nist": ["PR.PT", "PR.DS", "DE.CM", "ID.RA", "PR.IP"]}
modification_date = 2017-11-01
reference = ["https://www.owasp.org/index.php/SQL_Injection", "https://www.owasp.org/index.php/Blind_SQL_Injection", "https://www.incapsula.com/web-application-security/sql-injection.html"]
providing_technologies = ["Bro", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Splunk Stream", "macOS"]
detection_searches = ["ESCU - SQL Injection with Long URLs - Rule"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = It is very common for attackers to inject SQL parameters into vulnerable web applications, which then interpret the malicious SQL statements.\
\
This Analytic Story contains a search designed to identify attempts by attackers to leverage this technique to compromise a host and gain a foothold in the target environment.

[SamSam Ransomware]
category = Malware
creation_date = 2018-12-13
data_models = ["Application_State", "Authentication", "Endpoint", "Network_Traffic", "Risk", "Updates", "Vulnerabilities", "Web"]
description = Leverage searches that allow you to detect and investigate unusual activities that might relate to the SamSam ransomware, including looking for file writes associated with SamSam, RDP brute force attacks, the presence of files with SamSam ransomware extensions, suspicious psexec use, and more.
id = c4b89506-fbcf-4cb7-bfd6-527e54789604
version = 1.0
mappings = {"mitre_attack": ["Exploitation of Vulnerability", "System Information Discovery", "Commonly Used Port", "Command-Line Interface", "Credential Access", "Lateral Movement", "Defense Evasion", "Execution", "Remote Desktop Protocol", "Discovery"], "cis20": ["CIS 3", "CIS 18", "CIS 8", "CIS 9", "CIS 10", "CIS 12", "CIS 2", "CIS 4", "CIS 16"], "kill_chain_phases": ["Delivery", "Actions on Objectives", "Reconnaissance", "Installation", "Command and Control"], "nist": ["ID.AM", "PR.DS", "ID.RA", "PR.IP", "PR.PT", "PR.AC", "DE.AE", "PR.MA", "DE.CM"]}
modification_date = 2018-12-14
reference = ["https://www.crowdstrike.com/blog/an-in-depth-analysis-of-samsam-ransomware-and-boss-spider/", "https://www.sophos.com/en-us/medialibrary/PDFs/technical-papers/SamSam-ransomware-chooses-Its-targets-carefully-wpna.pdf", "https://www.sophos.com/en-us/medialibrary/PDFs/technical-papers/SamSam-The-Almost-Six-Million-Dollar-Ransomware.pdf?cmp=26061"]
providing_technologies = ["Apache", "Bluecoat", "Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Nessus", "Netbackup", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Deleting Shadow Copies - Rule", "ESCU - Spike in File Writes - Rule", "ESCU - Common Ransomware Extensions - Rule", "ESCU - Common Ransomware Notes - Rule", "ESCU - Prohibited Software On Endpoint - Rule", "ESCU - Detect PsExec With accepteula Flag - Rule", "ESCU - Remote Desktop Network Traffic - Rule", "ESCU - Detect attackers scanning for vulnerable JBoss servers - Rule", "ESCU - Detect malicious requests to exploit JBoss servers - Rule", "ESCU - Remote Desktop Network Bruteforce - Rule", "ESCU - File with Samsam Extension - Rule", "ESCU - Samsam Test File Write - Rule", "ESCU - Batch File Write to System32 - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Process Information For Port Activity", "ESCU - Investigate Web Activity From Host", "ESCU - Investigate Successful Remote Desktop Authentications", "ESCU - Get Parent Process Info"]
contextual_searches = ["ESCU - Get Backup Logs For Endpoint", "ESCU - Get Update Logs For Endpoint", "ESCU - Get Vulnerability Logs For Endpoint", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
support_searches = ["ESCU - Monitor Successful Backups", "ESCU - Monitor Unsuccessful Backups", "ESCU - Windows Updates Install Failures", "ESCU - Windows Updates Install Successes", "ESCU - Add Prohibited Processes to Enterprise Security"]
narrative = The first version of the SamSam ransomware (a.k.a. Samas or SamsamCrypt) was launched in 2015 by a group of Iranian threat actors. The malicious software has affected and continues to affect thousands of victims and has raised almost $6M in ransom.\
\
Although categorized under the heading of ransomware, SamSam campaigns have some importance distinguishing characteristics. Most notable is the fact that conventional ransomware is a numbers game. Perpetrators use a "spray-and-pray" approach with phishing campaigns or other mechanisms, charging a small ransom (typically under $1,000). The goal is to find a large number of victims willing to pay these mini-ransoms, adding up to a lucrative payday. They use relatively simple methods for infecting systems.\
\
SamSam attacks are different beasts. They have become progressively more targeted and skillful than typical ransomware attacks. First, malicious actors break into a victim's network, surveil it, then run the malware manually. The attacks are tailored to cause maximum damage and the threat actors usually demand amounts in the tens of thousands of dollars.\
\
In a typical attack on one large healthcare organization in 2018, the company ended up paying a ransom of four Bitcoins, then worth $56,707. Reports showed that access to the company's files was restored within two hours of paying the sum.\
\
According to Sophos, SamSam previously leveraged  RDP to gain access to targeted networks via brute force. SamSam is not spread automatically, like other malware. It requires skill because it forces the attacker to adapt their tactics to the individual environment. Next, the actors escalate their privileges to admin level. They scan the networks for worthy targets, using conventional tools, such as PsExec or PaExec, to deploy/execute, quickly encrypting files.\
\
This Analytic Story includes searches designed to help detect and investigate signs of the SamSam ransomware, such as the creation of fileswrites to system32, writes with tell-tale extensions, batch files written to system32, and evidence of brute-force attacks via RDP.

[Spectre And Meltdown Vulnerabilities]
category = Vulnerability
creation_date = 2018-01-08
data_models = ["Authentication", "Change_Analysis", "Risk", "Vulnerabilities"]
description = Assess and mitigate your systems' vulnerability to Spectre and Meltdown exploitation with the searches in this Analytic Story.
id = 6d3306f6-bb2b-4219-8609-8efad64032f2
version = 1.0
mappings = {"cis20": ["CIS 4"], "nist": ["DE.CM", "ID.RA", "RS.MI", "PR.IP"]}
modification_date = 2018-01-08
reference = ["https://meltdownattack.com/"]
providing_technologies = ["Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Nessus", "Qualys", "Splunk Enterprise Security", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Spectre and Meltdown Vulnerable Systems - Rule"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
support_searches = ["ESCU - Systems Ready for Spectre-Meltdown Windows Patch"]
narrative = Meltdown and Spectre exploit critical vulnerabilities in modern CPUs that allow unintended access to data in memory. This Analytic Story will help you identify the systems can be patched for these vulnerabilities, as well as those that still need to be patched.

[Splunk Enterprise Vulnerability]
category = Vulnerability
creation_date = 2016-09-13
data_models = ["Authentication", "Risk"]
description = Keeping your Splunk deployment up to date is critical and may help you reduce the risk of CVE-2016-4859, an open-redirection vulnerability within some older versions of Splunk Enterprise. The detection search will help ensure that users are being properly authenticated and not being redirected to malicious domains.
id = 4e692b96-de2d-4bd1-9105-37e2368a8db1
version = 1.0
mappings = {"mitre_attack": ["Exploitation of Vulnerability", "Defense Evasion"], "cis20": ["CIS 18", "CIS 4", "CIS 3"], "kill_chain_phases": ["Delivery"], "nist": ["ID.RA", "PR.IP", "PR.PT", "PR.AC", "RS.MI", "DE.CM"]}
modification_date = 2017-11-01
reference = ["http://www.splunk.com/view/SP-CAAAPQ6#announce", "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-4859"]
providing_technologies = ["Linux", "Microsoft Windows", "Splunk Enterprise", "Splunk Enterprise Security", "macOS"]
detection_searches = ["ESCU - Open Redirect in Splunk Web - Rule"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = This Analytic Story is associated with CVE-2016-4859, an open-redirect vulnerability in the following versions of Splunk Enterprise:\
\
\
\
1. Splunk Enterprise 6.4.x, prior to 6.4.3\
\
1. Splunk Enterprise 6.3.x, prior to 6.3.6\
\
1. Splunk Enterprise 6.2.x, prior to 6.2.10\
\
1. Splunk Enterprise 6.1.x, prior to 6.1.11\
\
1. Splunk Enterprise 6.0.x, prior to 6.0.12\
\
1. Splunk Enterprise 5.0.x, prior to 5.0.16\
\
1. Splunk Light, prior to 6.4.3CVE-2016-4859 allows attackers to redirect users to arbitrary web sites and conduct phishing attacks via unspecified vectors. (Credit: Noriaki Iwasaki, Cyber Defense Institute, Inc.).\
\
It is important to ensure that your Splunk deployment is being kept up to date and is properly configured. This detection search allows analysts to monitor internal logs to ensure users are properly authenticated and cannot be redirected to any malicious third-party websites.

[Splunk Enterprise Vulnerability CVE-2018-11409]
category = Vulnerability
creation_date = 2018-06-14
data_models = ["Network_Traffic", "Risk", "Web"]
description = Reduce the risk of CVE-2018-11409, an information disclosure vulnerability within some older versions of Splunk Enterprise, with searches designed to help ensure that your Splunk system does not leak information to authenticated users.
id = 1fc34cbc-34e9-43ba-87ab-6811c9e95400
version = 1.0
mappings = {"mitre_attack": ["Exploitation of Vulnerability", "Defense Evasion"], "cis20": ["CIS 18", "CIS 4", "CIS 3"], "kill_chain_phases": ["Delivery"], "nist": ["ID.RA", "PR.IP", "PR.PT", "PR.AC", "RS.MI", "DE.CM"]}
modification_date = 2018-06-15
reference = ["https://nvd.nist.gov/vuln/detail/CVE-2018-11409", "https://www.splunk.com/view/SP-CAAAP5E#VulnerabilityDescriptionsandRatings", "https://www.exploit-db.com/exploits/44865/"]
providing_technologies = ["Bluecoat", "Bro", "Palo Alto Firewall", "Splunk Enterprise", "Splunk Enterprise Security", "Splunk Stream"]
detection_searches = ["ESCU - Splunk Enterprise Information Disclosure - Rule"]
investigative_searches = ["ESCU - Investigate Web Activity From src_ip", "ESCU - Investigate Network Traffic From src_ip"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Although there have been no reports of it being exploited, Splunk Enterprise versions through 7.0.1 reportedly have a vulnerability that may expose information through a REST endpoint (read more here: https://www.splunk.com/view/SP-CAAAP5E#VulnerabilityDescriptionsandRatings). NIST has included it in its vulnerability database (read more here: https://nvd.nist.gov/vuln/detail/CVE-2018-11409). The REST endpoint that exposes system information is also necessary for the proper operation of Splunk clustering and instrumentation. Customers should upgrade to the latest version to reduce the risk of this vulnerability.\
\
Splunk Enterprise exposes partial information about the host operating system, hardware, and Splunk license. Splunk Enterprise before 6.6.0 exposes this information without authentication. Splunk Enterprise 6.6.0 and later exposes this information only to authenticated Splunk users. Based on the information exposure, Splunk characterizes this issue as a low severity impact.\
\
Read more in Splunk's official response: https://www.splunk.com/view/SP-CAAAP5E#VulnerabilityDescriptionsandRatings.\
\
A detection search within this Analytic Story looks for vulnerabilities described in CVE-2018-11409: Information Exposure (https://nvd.nist.gov/vuln/detail/CVE-2018-11409). If it turns up activities that may be specific, you can use the included investigative searches to return information regarding web activity and network traffic by src_ip.

[Suspicious AWS EC2 Activities]
category = Cloud Security
creation_date = 2018-02-09
data_models =
description = Use the searches in this Analytic Story to monitor your AWS EC2 instances for evidence of anomalous activity and suspicious behaviors, such as EC2 instances that originate from unusual locations or those launched by previously unseen users (among others). Included investigative searches will help you probe more deeply, when the information warrants it.
id = 2e8948a5-5239-406b-b56b-6c50f1268af3
version = 1.0
mappings = {"mitre_attack": ["Defense Evasion", "Execution"], "cis20": ["CIS 12", "CIS 13", "CIS 1"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["ID.AM", "DE.AE", "DE.DP"]}
modification_date = 2018-03-15
reference = ["https://d0.awsstatic.com/whitepapers/aws-security-best-practices.pdf"]
providing_technologies = ["AWS", "Splunk Enterprise Security"]
detection_searches = ["ESCU - EC2 Instance Started In Previously Unseen Region - Rule", "ESCU - Abnormally High AWS Instances Terminated by User - Rule", "ESCU - Abnormally High AWS Instances Launched by User - Rule", "ESCU - EC2 Instance Started With Previously Unseen User - Rule"]
investigative_searches = ["ESCU - Investigate AWS activities via region name", "ESCU - AWS Investigate User Activities By ARN"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get EC2 Instance Details by instanceId"]
support_searches = ["ESCU - Previously Seen AWS Regions", "ESCU - Previously Seen EC2 Launches By User"]
narrative = AWS CloudTrail is an AWS service that helps you enable governance, compliance, and risk auditing within your AWS account. Actions taken by a user, role, or an AWS service are recorded as events in CloudTrail. It is crucial for a company to monitor events and actions taken in the AWS Console, AWS command-line interface, and AWS SDKs and APIs to ensure that your EC2 instances are not vulnerable to attacks. This Analytic Story identifies suspicious activities in your AWS EC2 instances and helps you respond and investigate those activities.

[Suspicious AWS Login Activities]
category = Cloud Security
creation_date = 2018-02-24
data_models =
description = Monitor your AWS authentication events using your CloudTrail logs. Searches within this Analytic Story will help you stay aware of and investigate suspicious logins. 
id = 2e8948a5-5239-406b-b56b-6c59f1268af3
version = 1.0
mappings = {"mitre_attack": ["Credential Access"], "cis20": ["CIS 16"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["DE.AE", "DE.DP"]}
modification_date = 2018-02-26
reference = ["https://docs.aws.amazon.com/IAM/latest/UserGuide/cloudtrail-integration.html   "]
providing_technologies = ["AWS", "Splunk Enterprise Security"]
detection_searches = ["ESCU - Detect new user AWS Console Login - Rule"]
investigative_searches = ["ESCU - AWS Investigate User Activities By ARN"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table"]
support_searches = ["ESCU - Previously seen users in CloudTrail"]
narrative = It is important to monitor and control who has access to your AWS infrastructure. Detecting suspicious logins to your AWS infrastructure will provide good starting points for investigations. Abusive behaviors caused by compromised credentials can lead to direct monetary costs, as you will be billed for any EC2 instances created by the attacker.

[Suspicious AWS S3 Activities]
category = Cloud Security
creation_date = 2018-06-25
data_models =
description = Use the searches in this Analytic Story to monitor your AWS S3 buckets for evidence of anomalous activity and suspicious behaviors, such as detecting open S3 buckets and buckets being accessed from a new IP. The contextual and investigative searches will give you more information, when required.
id = 2e8948a5-5239-406b-b56b-6c50w3168af3
version = 2.0
mappings = {"mitre_attack": ["Exfiltration", "Credential Access", "Execution", "Initial Access"], "cis20": ["CIS 13", "CIS 14"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["DE.DP", "PR.DS", "DE.CM", "PR.AC"]}
modification_date = 2018-11-27
reference = ["https://d0.awsstatic.com/whitepapers/aws-security-best-practices.pdf", "https://www.tripwire.com/state-of-security/security-data-protection/cloud/public-aws-s3-buckets-writable/"]
providing_technologies = ["AWS", "Splunk Enterprise Security"]
detection_searches = ["ESCU - Detect New Open S3 buckets - Rule", "ESCU - Detect S3 access from a new IP - Rule", "ESCU - Detect Spike in S3 Bucket deletion - Rule"]
investigative_searches = ["ESCU - Investigate AWS activities via region name", "ESCU - AWS Investigate User Activities By ARN", "ESCU - Get All AWS Activity From IP Address"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - AWS S3 Bucket details via bucketName"]
support_searches = ["ESCU - Previously seen S3 bucket access by remote IP", "ESCU - Baseline of S3 Bucket deletion activity by ARN"]
narrative = As cloud computing has exploded, so has the number of creative attacks on virtual environments. And as the number-two cloud-service provider, Amazon Web Services (AWS) has certainly had its share.\
\
Amazon's "shared responsibility" model dictates that the company has responsibility for the environment outside of the VM and the customer is responsible for the security inside of the S3 container. As such, it's important to stay vigilant for activities that may belie suspicious behavior inside of your environment.\
\
Among things to look out for are S3 access from unfamiliar locations and by unfamiliar users. Some of the searches in this Analytic Story help you detect suspicious behavior and others help you investigate more deeply, when the situation warrants.   

[Suspicious AWS Traffic]
category = Cloud Security
creation_date = 2018-05-07
data_models =
description = Leverage these searches to monitor your AWS network traffic for evidence of anomalous activity and suspicious behaviors, such as a spike in blocked outbound traffic in your virtual private cloud (VPC).
id = 2e8948a5-5239-406b-b56b-6c50f2168af3
version = 1.0
mappings = {"mitre_attack": ["Command and Control", "Exfiltration"], "cis20": ["CIS 11"], "kill_chain_phases": ["Command and Control", "Actions on Objectives"], "nist": ["DE.AE", "DE.CM", "PR.AC"]}
modification_date = 2018-05-07
reference = ["https://rhinosecuritylabs.com/aws/hiding-cloudcobalt-strike-beacon-c2-using-amazon-apis/"]
providing_technologies = ["AWS", "Splunk Enterprise Security"]
detection_searches = ["ESCU - Detect Spike in blocked Outbound Traffic from your AWS - Rule"]
investigative_searches = ["ESCU - Get All AWS Activity From IP Address"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - AWS Network Interface details via resourceId"]
support_searches = ["ESCU - Baseline of blocked outbound traffic from AWS"]
narrative = A virtual private cloud (VPC) is an on-demand managed cloud-computing service that isolates computing resources for each client. Inside the VPC container, the environment resembles a physical network. \
\
Amazon's VPC service enables you to launch EC2 instances and leverage other Amazon resources. The traffic that flows in and out of this VPC can be controlled via network access-control rules and security groups. Amazon also has a feature called VPC Flow Logs that enables you to log IP traffic going to and from the network interfaces in your VPC. This data is stored using Amazon CloudWatch Logs.\
\
 Attackers may abuse the AWS infrastructure with insecure VPCs so they can co-opt AWS resources for command-and-control nodes, data exfiltration, and more. Once an EC2 instance is compromised, an attacker may initiate outbound network connections for malicious reasons. Monitoring these network traffic behaviors is crucial for understanding the type of traffic flowing in and out of your network and to alert you to suspicious activities.\
\
The searches in this Analytic Story will monitor your AWS network traffic for evidence of anomalous activity and suspicious behaviors.

[Suspicious Command-Line Executions]
category = Adversary Tactics
creation_date = 2017-10-09
data_models = ["Application_State", "Authentication", "Endpoint", "Web"]
description = Leveraging the Windows command-line interface (CLI) is one of the most common attack techniques--one that is also detailed in the MITRE ATT&CK framework. Use this Analytic Story to help you identify unusual or suspicious use of the CLI on Windows systems.
id = f4368ddf-d59f-4192-84f6-778ac5a3ffc7
version = 2.0
mappings = {"mitre_attack": ["Masquerading", "Command-Line Interface", "Scripting", "Defense Evasion", "Execution", "Persistence"], "cis20": ["CIS 3", "CIS 8"], "kill_chain_phases": ["Exploitation", "Actions on Objectives", "Command and Control"], "nist": ["PR.PT", "DE.CM", "PR.IP"]}
modification_date = 2018-11-15
reference = ["https://attack.mitre.org/wiki/Technique/T1059", "https://www.microsoft.com/en-us/wdsi/threats/macro-malware", "https://www.fireeye.com/content/dam/fireeye-www/services/pdfs/mandiant-apt1-report.pdf"]
providing_technologies = ["Bluecoat", "Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - First time seen command line argument - Rule", "ESCU - Unusually Long Command Line - Rule", "ESCU - Detect Prohibited Applications Spawning cmd.exe - Rule", "ESCU - Detect Use of cmd.exe to Launch Script Interpreters - Rule", "ESCU - System Processes Run From Unexpected Locations - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info", "ESCU - Investigate Web Activity From Host"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint"]
support_searches = ["ESCU - Previously seen command line arguments"]
narrative = The ability to execute arbitrary commands via the Windows CLI is a primary goal for the adversary. With access to the shell, an attacker can easily run scripts and interact with the target system. Often, attackers may only have limited access to the shell or may obtain access in unusual ways. In addition, malware may execute and interact with the CLI in ways that would be considered unusual and inconsistent with typical user activity. This provides defenders with opportunities to identify suspicious use and investigate, as appropriate. This Analytic Story contains various searches to help identify this suspicious activity, as well as others to aid you in deeper investigation.

[Suspicious DNS Traffic]
category = Adversary Tactics
creation_date = 2016-09-13
data_models = ["Application_State", "Authentication", "Network_Resolution", "Network_Traffic", "Risk"]
description = Attackers often attempt to hide within or otherwise abuse the domain name system (DNS). You can thwart attempts to manipulate this omnipresent protocol by monitoring for these types of abuses.
id = 3c3835c0-255d-4f9e-ab84-e29ec9ec9b56
version = 1.0
mappings = {"mitre_attack": ["Command and Control", "Exfiltration Over Command and Control Channel", "Commonly Used Port", "Exfiltration Over Alternative Protocol", "Exfiltration", "Standard Application Layer Protocol", "Defense Evasion"], "cis20": ["CIS 8", "CIS 9", "CIS 12", "CIS 13", "CIS 3", "CIS 1"], "kill_chain_phases": ["Command and Control", "Actions on Objectives"], "nist": ["ID.AM", "PR.DS", "PR.IP", "PR.PT", "DE.AE", "DE.CM"]}
modification_date = 2018-07-24
reference = ["http://blogs.splunk.com/2015/10/01/random-words-on-entropy-and-dns/", "http://www.darkreading.com/analytics/security-monitoring/got-malware-three-signs-revealed-in-dns-traffic/d/d-id/1139680", "https://live.paloaltonetworks.com/t5/Threat-Vulnerability-Articles/What-are-suspicious-DNS-queries/ta-p/71454"]
providing_technologies = ["Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Excessive DNS Failures - Rule", "ESCU - Clients Connecting to Multiple DNS Servers - Rule", "ESCU - DNS Query Length With High Standard Deviation - Rule", "ESCU - DNS Query Requests Resolved by Unauthorized DNS Servers - Rule", "ESCU - Detect Long DNS TXT Record Response - Rule", "ESCU - Detection of DNS Tunnels - Rule", "ESCU - Detect hosts connecting to dynamic domain providers - Rule"]
investigative_searches = ["ESCU - Get DNS Server History for a host", "ESCU - Get DNS traffic ratio", "ESCU - Get Process responsible for the DNS traffic"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Although DNS is one of the fundamental underlying protocols that make the Internet work, it is often ignored (perhaps because of its complexity and effectiveness).  However, attackers have discovered ways to abuse the protocol to meet their objectives. One potential abuse involves manipulating DNS to hijack traffic and redirect it to an IP address under the attacker's control. This could inadvertently send users intending to visit google.com, for example, to an unrelated malicious website. Another technique involves using the DNS protocol for command-and-control activities with the attacker's malicious code or to covertly exfiltrate data. The searches within this Analytic Story look for these types of abuses.

[Suspicious Emails]
category = Adversary Tactics
creation_date = 2017-03-24
data_models = ["Authentication", "Email", "Risk", "Web"]
description = Email remains one of the primary means for attackers to gain an initial foothold within the modern enterprise. Detect and investigate suspicious emails in your environment with the help of the searches in this Analytic Story.
id = 2b1800dd-92f9-47ec-a981-fdf1351e5d55
version = 1.0
mappings = {"mitre_attack": ["Defense Evasion", "Execution"], "cis20": ["CIS 7", "CIS 12", "CIS 3"], "kill_chain_phases": ["Delivery"], "nist": ["DE.AE", "PR.IP"]}
modification_date = 2017-11-09
reference = ["https://www.splunk.com/blog/2015/06/26/phishing-hits-a-new-level-of-quality/"]
providing_technologies = ["Bluecoat", "Bro", "Linux", "Microsoft Exchange", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "macOS"]
detection_searches = ["ESCU - Suspicious Email Attachment Extensions - Rule", "ESCU - Email Attachments With Lots Of Spaces - Rule"]
investigative_searches = ["ESCU - Get Email Info", "ESCU - Get Emails From Specific Sender", "ESCU - Investigate Web Activity From Host"]
contextual_searches = ["ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = It is a common practice for attackers of all types to leverage targeted spearphishing campaigns and mass mailers to deliver weaponized email messages and attachments. Fortunately, there are a number of ways to monitor email data in Splunk to detect suspicious content.\
\
Once a phishing message has been detected, the next steps are to answer the following questions: \
\
1. Which users have received this or a similar message in the past?\
\
1. When did the targeted campaign begin?\
\
1. Have any users interacted with the content of the messages (by downloading an attachment or clicking on a malicious URL)?This Analytic Story provides detection searches to identify suspicious emails, as well as contextual and investigative searches to help answer some of these questions.

[Suspicious MSHTA Activity]
category = Adversary Tactics
creation_date = 2018-08-07
data_models = ["Application_State", "Authentication", "Endpoint", "Risk"]
description = Monitor and detect techniques used by attackers who leverage the mshta.exe process to execute malicious code.
id = 2b1800dd-92f9-47dd-a981-fdf13w1q5d55
version = 1.0
mappings = {"mitre_attack": ["Command-Line Interface", "Registry Run Keys / Start Folder", "Persistence", "Authentication Package", "Execution", "AppInit DLLs"], "cis20": ["CIS 8"], "kill_chain_phases": ["Exploitation", "Actions on Objectives"], "nist": ["PR.PT", "DE.AE", "DE.CM"]}
modification_date = 2018-12-03
reference = ["https://redcanary.com/blog/windows-registry-attacks-threat-detection/", "https://medium.com/@mbromileyDFIR/malware-monday-aebb456356c5", "https://attack.mitre.org/wiki/Technique/T1170"]
providing_technologies = ["Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Detect mshta.exe running scripts in command-line arguments - Rule", "ESCU - Registry Keys Used For Persistence - Rule", "ESCU - Detect Prohibited Applications Spawning cmd.exe - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Registry Activities", "ESCU - Get Parent Process Info"]
contextual_searches = ["ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = One common adversary tactic is to bypass application white-listing solutions via the mshta.exe process, which executes Microsoft HTML applications with the .hta suffix. In these cases, attackers use the trusted Windows utility to eproxy execution of malicious files, whether an .hta application, javascript, or VBScript.\
\
One example of a notable mshta.exe attack was the Kovter malware (https://medium.com/@mbromileyDFIR/malware-monday-aebb456356c5) that was implicated in ransomware and click-fraud attacks. Kovter utilized .hta to execute a series of javascript commands, each progressively more dangerous. According to the Mitre Parternship Network (https://attack.mitre.org/wiki/Technique/T1170), FIN7 has leveraged mshta.exe, as has the MuddyWater group, who used it to execute its POWERSTATS payload (which then used the utility to execute additional payloads).\
\
The searches in this story help you detect and investigate suspicious activity that may indicate that an attacker is leveraging mshta.exe to execute malicious code.

[Suspicious WMI Use]
category = Adversary Tactics
creation_date = 2017-01-13
data_models = ["Application_State", "Authentication", "Endpoint", "Risk"]
description = Attackers are increasingly abusing Windows Management Instrumentation (WMI), a framework and associated utilities available on all modern Windows operating systems. Because WMI can be leveraged to manage both local and remote systems, it is important to identify the processes executed and the user context within which the activity occurred.
id = c8ddc5be-69bc-4202-b3ab-4010b27d7ad5
version = 2.0
mappings = {"mitre_attack": ["Windows Management Instrumentation", "Windows Management Instrumentation Event Subscription", "Execution", "Persistence"], "cis20": ["CIS 5", "CIS 3"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["PR.PT", "PR.AT", "PR.AC", "PR.IP"]}
modification_date = 2018-12-03
reference = ["https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf", "https://www.fireeye.com/blog/threat-research/2017/03/wmimplant_a_wmi_ba.html"]
providing_technologies = ["Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Remote WMI Command Attempt - Rule", "ESCU - Remote Process Instantiation via WMI - Rule", "ESCU - WMI Permanent Event Subscription - Rule", "ESCU - WMI Permanent Event Subscription - Sysmon - Rule", "ESCU - WMI Temporary Event Subscription - Rule", "ESCU - Process Execution via WMI - Rule", "ESCU - Script Execution via WMI - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Sysmon WMI Activity for Host"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = WMI is a Microsoft infrastructure for management data and operations on Windows operating systems. It includes of a set of utilities that can be leveraged to manage both local and remote Windows systems. Attackers are increasingly turning to WMI abuse in their efforts to conduct nefarious tasks, such as reconnaissance, detection of antivirus and virtual machines, code execution, lateral movement, persistence, and data exfiltration. \
\
The detection searches included in this Analytic Story are used to look for suspicious use of WMI commands that attackers may leverage to interact with remote systems. The searches specifically look for the use of WMI to run processes on remote systems.\
\
In the event that unauthorized WMI execution occurs, it will be important for analysts and investigators to determine the context of the event. These details may provide insights related to how WMI was used and to what end.

[Suspicious Windows Registry Activities]
category = Adversary Tactics
creation_date = 2018-05-31
data_models = ["Application_State", "Authentication", "Change_Analysis", "Endpoint", "Risk"]
description = Monitor and detect registry changes initiated from remote locations, which can be a sign that an attacker has infiltrated your system.
id = 2b1800dd-92f9-47dd-a981-fdf1351e5d55
version = 1.0
mappings = {"mitre_attack": ["Modify Registry", "Local Port Monitor", "Authentication Package", "Lateral Movement", "Application Shimming", "Registry Run Keys / Start Folder", "AppInit DLLs", "Privilege Escalation", "Defense Evasion", "Accessibility Features", "Change Default File Association", "Persistence"], "cis20": ["CIS 5", "CIS 3", "CIS 8"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["PR.PT", "DE.AE", "DE.CM", "PR.AC", "PR.IP"]}
modification_date = 2018-12-03
reference = ["https://redcanary.com/blog/windows-registry-attacks-threat-detection/", "https://attack.mitre.org/wiki/Technique/T1112"]
providing_technologies = ["Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Remote Registry Key modifications - Rule", "ESCU - Suspicious Changes to File Associations - Rule", "ESCU - Disabling Remote User Account Control - Rule", "ESCU - Registry Keys for Creating SHIM Databases - Rule", "ESCU - Monitor Registry Keys for Print Monitors - Rule", "ESCU - Reg.exe used to hide files/directories via registry keys - Rule", "ESCU - Registry Keys Used For Persistence - Rule", "ESCU - Registry Keys Used For Privilege Escalation - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info", "ESCU - Get Registry Activities"]
contextual_searches = ["ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Attackers are developing increasingly sophisticated techniques for hijacking target servers, while evading detection. One such technique that has become progressively more common is registry modification.\
\
 The registry is a key component of the Windows operating system. It has a hierarchical database called "registry" that contains settings, options, and values for executables. Once the threat actor gains access to a machine, they can use reg.exe to modify their account to obtain administrator-level privileges, maintain persistence, and move laterally within the environment.\
\
 The searches in this story are designed to help you detect behaviors associated with manipulation of the Windows registry.

[Unusual AWS EC2 Modifications]
category = Cloud Security
creation_date = 2018-04-09
data_models =
description = Identify unusual changes to your AWS EC2 instances that may indicate malicious activity. Modifications to your EC2 instances by previously unseen users is an example of an activity that may warrant further investigation.
id = 73de57ef-0dfc-411f-b1e7-fa24428aeae0
version = 1.0
mappings = {"cis20": ["CIS 1"], "nist": ["ID.AM"]}
modification_date = 2018-04-09
reference = ["https://d0.awsstatic.com/whitepapers/aws-security-best-practices.pdf"]
providing_technologies = ["AWS", "Splunk Enterprise Security"]
detection_searches = ["ESCU - EC2 Instance Modified With Previously Unseen User - Rule"]
investigative_searches = ["ESCU - AWS Investigate User Activities By ARN"]
contextual_searches = ["ESCU - Get Notable History", "ESCU - Get EC2 Instance Details by instanceId"]
support_searches = ["ESCU - Previously Seen EC2 Modifications By User"]
narrative = A common attack technique is to infiltrate a cloud instance and make modifications. The adversary can then secure access to your infrastructure or hide their activities. So it's important to stay alert to changes that may indicate that your environment has been compromised. \
\
 Searches within this Analytic Story can help you detect the presence of a threat by monitoring for EC2 instances that have been created or changed--either by users that have never previously performed these activities or by known users who modify or create instances in a way that have not been done before. This story also provides investigative searches that help you go deeper once you detect suspicious behavior.

[Unusual Processes]
category = Malware
creation_date = 2016-08-09
data_models = ["Application_State", "Authentication", "Endpoint", "Risk", "Web"]
description = Quickly identify systems running new or unusual processes in your environment that could be indicators of suspicious activity. Processes run from unusual locations, those with conspicuously long command lines, and rare executables are all examples of activities that may warrant deeper investigation.
id = f4368e3f-d59f-4192-84f6-748ac5a3ddb6
version = 2.0
mappings = {"mitre_attack": ["Defense Evasion", "Execution", "Rundll32", "Accessibility Features", "Masquerading"], "cis20": ["CIS 2", "CIS 8"], "kill_chain_phases": ["Command and Control", "Actions on Objectives", "Installation"], "nist": ["ID.AM", "PR.PT", "PR.DS", "DE.CM"]}
modification_date = 2018-11-20
reference = ["https://www.fireeye.com/blog/threat-research/2017/08/monitoring-windows-console-activity-part-two.html", "https://www.splunk.com/pdfs/technical-briefs/advanced-threat-detection-and-response-tech-brief.pdf", "https://www.sans.org/reading-room/whitepapers/logging/detecting-security-incidents-windows-workstation-event-logs-34262"]
providing_technologies = ["Bluecoat", "Bro", "Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Uncommon Processes On Endpoint - Rule", "ESCU - Unusually Long Command Line - Rule", "ESCU - Detect Rare Executables - Rule", "ESCU - System Processes Run From Unexpected Locations - Rule", "ESCU - RunDLL Loading DLL By Ordinal - Rule", "ESCU - Detect processes used for System Network Configuration Discovery - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Investigate Web Activity From Host"]
contextual_searches = ["ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Being able to profile a host's processes within your environment can help you more quickly identify processes that seem out of place when compared to the rest of the population of hosts or asset types.\
\
This Analytic Story lets you identify processes that are either a) not typically seen running or b) have some sort of suspicious command-line arguments associated with them. This Analytic Story will also help you identify the user running these processes and the associated process activity on the host.\
\
In the event an unusual process is identified, it is imperative to better understand how that process was able to execute on the host, when it first executed, and whether other hosts are affected. This extra information may provide clues that can help the analyst further investigate any suspicious activity.

[Use of Cleartext Protocols]
category = Best Practices
creation_date = 2016-09-13
data_models = ["Application_State", "Network_Traffic", "Risk"]
description = Leverage searches that detect cleartext network protocols that may leak credentials or should otherwise be encrypted.
id = 826e6431-aeef-41b4-9fc0-6d0985d65a21
version = 1.0
mappings = {"mitre_attack": ["Lateral Movement", "Credential Access", "Collection"], "cis20": ["CIS 14", "CIS 9"], "kill_chain_phases": ["Actions on Objectives", "Reconnaissance"], "nist": ["PR.PT", "DE.AE", "PR.AC", "PR.DS"]}
modification_date = 2017-10-19
reference = ["https://www.monkey.org/~dugsong/dsniff/"]
providing_technologies = ["Bluecoat", "Bro", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream"]
detection_searches = ["ESCU - Protocols passing authentication in cleartext - Rule"]
investigative_searches = ["ESCU - Get Process Information For Port Activity"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Various legacy protocols operate by default in the clear, without the protections of encryption. This potentially leaks sensitive information that can be exploited by passively sniffing network traffic. Depending on the protocol, this information could be highly sensitive, or could allow for session hijacking. In addition, these protocols send authentication information, which would allow for the harvesting of usernames and passwords that could potentially be used to authenticate and compromise secondary systems.

[Web Fraud Detection]
category = Abuse
creation_date = 2018-07-12
data_models = ["Email"]
description = Monitor your environment for activity consistent with common attack techniques bad actors use when attempting to compromise web servers or other web-related assets.
id = 31337aaa-bc22-4752-b599-ef112dq1dq7a
version = 1.0
mappings = {"mitre_attack": ["Valid Accounts", "Create Account"], "cis20": ["CIS 6", "CIS 16"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["DE.DP", "DE.AE", "DE.CM"]}
modification_date = 2018-10-08
reference = ["https://www.fbi.gov/scams-and-safety/common-fraud-schemes/internet-fraud", "https://www.fbi.gov/news/stories/2017-internet-crime-report-released-050718", "https://www.otalliance.org/news-events/press-releases/online-trust-alliance-reports-doubling-cyber-incidents-2017-0"]
providing_technologies = ["Bro", "Microsoft Exchange", "Palo Alto Firewall", "Splunk Enterprise Security", "Splunk Stream"]
detection_searches = ["ESCU - Web Fraud - Account Harvesting - Rule", "ESCU - Web Fraud - Anomalous User Clickspeed - Rule", "ESCU - Web Fraud - Password Sharing Across Accounts - Rule"]
investigative_searches = ["ESCU - Get Emails From Specific Sender", "ESCU - Get Web Session Information via session_id"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History"]
narrative = The Federal Bureau of Investigations (FBI) defines Internet fraud as the use of Internet services or software with Internet access to defraud victims or to otherwise take advantage of them. According to the Bureau, Internet crime schemes are used to steal millions of dollars each year from victims and continue to plague the Internet through various methods. The agency includes phishing scams, data breaches, Denial of Service (DOS) attacks, email account compromise, malware, spoofing, and ransomware in this category.\
\
These crimes are not the fraud itself, but rather the attack techniques commonly employed by fraudsters in their pursuit of data that enables them to commit malicious actssuch as obtaining and using stolen credit cards. They represent a serious problem that is steadily increasing and not likely to go away anytime soon.\
\
When developing a strategy for preventing fraud in your environment, its important to  look across all of your web services for evidence that attackers are abusing enterprise resources to enumerate systems, harvest data for secondary fraudulent activity, or abuse terms of service.This Analytic Story looks for evidence of common Internet attack techniques that could be indicative of web fraud in your environmentincluding account harvesting, anomalous user clickspeed, and password sharing across accounts, to name just a few.\
\
The account-harvesting search focuses on web pages used for user-account registration. It detects the creation of a large number of user accounts using the same email domain name, a type of activity frequently seen in advance of a fraud campaign.\
\
The anomalous clickspeed search looks for users who are moving through your website at a faster-than-normal speed or with a perfect click cadence (high periodicity or low standard deviation), which could indicate that the user is a script, not an actual human.\
\
Another search detects incidents wherein a single password is used across multiple accounts, which may indicate that a fraudster has infiltrated your environment and embedded a common password within a script.

[Windows Defense Evasion Tactics]
category = Adversary Tactics
creation_date = 2017-10-11
data_models = ["Application_State", "Authentication", "Endpoint"]
description = Detect tactics used by malware to evade defenses on Windows endpoints. A few of these include suspicious `reg.exe` processes, files hidden with `attrib.exe` and disabling user-account control, among many others 
id = 56e24a28-5003-4047-b2db-e8f3c4618064
version = 1.0
mappings = {"mitre_attack": ["Disabling Security Tools", "Lateral Movement", "Defense Evasion", "Modify Registry", "Persistence"], "cis20": ["CIS 8"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["PR.PT", "DE.CM"]}
modification_date = 2018-12-03
reference = ["https://attack.mitre.org/wiki/Defense_Evasion"]
providing_technologies = ["Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Suspicious Reg.exe Process - Rule", "ESCU - Disabling Remote User Account Control - Rule", "ESCU - Hiding Files And Directories With Attrib.exe - Rule", "ESCU - Reg.exe used to hide files/directories via registry keys - Rule", "ESCU - Remote Registry Key modifications - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint"]
narrative = Defense evasion is a tactic--identified in the MITRE ATT&CK framework--that adversaries employ in a variety of ways to bypass or defeat defensive security measures. There are many techniques enumerated by the MITRE ATT&CK framework that are applicable in this context. This Analytic Story includes searches designed to identify the use of such techniques on Windows platforms.

[Windows File Extension and Association Abuse]
category = Malware
creation_date = 2018-01-26
data_models = ["Application_State", "Authentication", "Endpoint", "Risk"]
description = Detect and investigate suspected abuse of file extensions and Windows file associations. Some of the malicious behaviors involved may include inserting spaces before file extensions or prepending the file extension with a different one, among other techniques.
id = 30552a76-ac78-48e4-b3c0-de4e34e9563d
version = 1.0
mappings = {"mitre_attack": ["Execution", "Change Default File Association", "Persistence"], "cis20": ["CIS 3", "CIS 8"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["PR.PT", "DE.CM", "PR.IP"]}
modification_date = 2018-11-02
reference = ["https://blog.malwarebytes.com/cybercrime/2013/12/file-extensions-2/", "https://attack.mitre.org/wiki/Technique/T1042"]
providing_technologies = ["Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Execution of File with Multiple Extensions - Rule", "ESCU - Execution of File With Spaces Before Extension - Rule", "ESCU - Suspicious Changes to File Associations - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Attackers use a variety of techniques to entice users to run malicious code or to persist on an endpoint. One way to accomplish these goals is to leverage file extensions and the mechanism Windows uses to associate files with specific applications. \
\
 Since its earliest days, Windows has used extensions to identify file types. Users have become familiar with these extensions and their application associations. For example, if users see that a file ends in `.doc` or `.docx`, they will assume that it is a Microsoft Word document and expect that double-clicking will open it using `winword.exe`. The user will typically also presume that the `.docx` file is safe. \
\
 Attackers take advantage of this expectation by obfuscating the true file extension. They can accomplish this in a couple of ways. One technique involves inserting multiple spaces in the file name before the extension to hide the extension from the GUI, obscuring the true nature of the file. Another approach involves prepending the real extension with a different one. This is especially effective when Windows is configured to "hide extensions for known file types." In this case, the real extension is not displayed, but the prepended one is, leading end users to believe the file is a different type than it actually is.\
\
Changing the association between a file extension and an application can allow an attacker to execute arbitrary code. The technique typically involves changing the association for an often-launched file type to associate instead with a malicious program the attacker has dropped on the endpoint. When the end user launches a file that has been manipulated in this way, it will execute the attacker's malware. It will also execute the application the end user expected to run, cleverly obscuring the fact that something suspicious has occurred.\
\
Run the searches in this story to detect and investigate suspicious behavior that may indicate abuse or manipulation of Windows file extensions and/or associations.

[Windows Log Manipulation]
category = Adversary Tactics
creation_date = 2017-02-17
data_models = ["Application_State", "Authentication", "Endpoint", "Risk"]
description = Adversaries often try to cover their tracks by manipulating Windows logs. Use these searches to help you monitor for suspicious activity surrounding log files--an essential component of an effective defense.
id = b6db2c60-a281-48b4-95f1-2cd99ed56835
version = 2.0
mappings = {"mitre_attack": ["Indicator Removal on Host", "Defense Evasion", "Execution"], "cis20": ["CIS 6", "CIS 10", "CIS 5", "CIS 3", "CIS 8"], "kill_chain_phases": ["Actions on Objectives"], "nist": ["DE.DP", "PR.IP", "PR.PT", "PR.AC", "DE.AE", "DE.CM", "PR.AT"]}
modification_date = 2018-12-03
reference = ["https://www.crowdstrike.com/blog/bears-midst-intrusion-democratic-national-committee/", "https://zeltser.com/security-incident-log-review-checklist/", "http://journeyintoir.blogspot.com/2013/01/re-introducing-usnjrnl.html"]
providing_technologies = ["Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Deleting Shadow Copies - Rule", "ESCU - Windows Event Log Cleared - Rule", "ESCU - Suspicious wevtutil Usage - Rule", "ESCU - USN Journal Deletion - Rule"]
investigative_searches = ["ESCU - Get Process Info"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Because attackers often modify system logs to cover their tracks and/or to thwart the investigative process, log monitoring is an industry-recognized best practice. While there are legitimate reasons to manipulate system logs, it is still worthwhile to keep track of who manipulated the logs, when they manipulated them, and in what way they manipulated them (determining which accesses, tools, or utilities were employed). Even if no malicious activity is detected, the knowledge of an attempt to manipulate system logs may be indicative of a broader security risk that should be thoroughly investigated.\
\
The Analytic Story gives users two different ways to detect manipulation of Windows Event Logs and one way to detect deletion of the Update Sequence Number (USN) Change Journal. The story helps determine the history of the host and the users who have accessed it. Finally, the story aides in investigation by retrieving all the information on the process that caused these events (if the process has been identified).

[Windows Persistence Techniques]
category = Adversary Tactics
creation_date = 2017-04-19
data_models = ["Application_State", "Authentication", "Change_Analysis", "Endpoint", "Risk"]
description = Monitor for activities and techniques associated with maintaining persistence on a Windows system--a sign that an adversary may have compromised your environment.
id = 30874d4f-20a1-488f-85ec-5d52ef74e3f9
version = 2.0
mappings = {"mitre_attack": ["New Service", "Modify Existing Service", "Local Port Monitor", "Scheduled Task", "Disabling Security Tools", "Lateral Movement", "Application Shimming", "Registry Run Keys / Start Folder", "AppInit DLLs", "Privilege Escalation", "Defense Evasion", "Execution", "Authentication Package", "Persistence"], "cis20": ["CIS 5", "CIS 3", "CIS 8"], "kill_chain_phases": ["Actions on Objectives", "Installation"], "nist": ["PR.IP", "PR.PT", "PR.AC", "DE.AE", "DE.CM", "PR.AT"]}
modification_date = 2018-11-15
reference = ["http://www.fuzzysecurity.com/tutorials/19.html", "https://www.fireeye.com/blog/threat-research/2010/07/malware-persistence-windows-registry.html", "http://resources.infosecinstitute.com/common-malware-persistence-mechanisms/", "https://www.fireeye.com/blog/threat-research/2017/05/fin7-shim-databases-persistence.html", "https://www.defcon.org/images/defcon-22/dc-22-presentations/Bloxham/DEFCON-22-Brady-Bloxham-Windows-API-Abuse-UPDATED.pdf"]
providing_technologies = ["Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Registry Keys for Creating SHIM Databases - Rule", "ESCU - Shim Database Installation With Suspicious Parameters - Rule", "ESCU - Shim Database File Creation - Rule", "ESCU - Registry Keys Used For Persistence - Rule", "ESCU - Schtasks used for forcing a reboot - Rule", "ESCU - Sc.exe Manipulating Windows Services - Rule", "ESCU - Reg.exe Manipulating Windows Services Registry Keys - Rule", "ESCU - Hiding Files And Directories With Attrib.exe - Rule", "ESCU - Reg.exe used to hide files/directories via registry keys - Rule", "ESCU - Detect Path Interception By Creation Of program.exe - Rule", "ESCU - Monitor Registry Keys for Print Monitors - Rule", "ESCU - Remote Registry Key modifications - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Maintaining persistence is one of the first steps taken by attackers after the initial compromise. Attackers leverage various custom and built-in tools to ensure survivability and persistent access within a compromised enterprise. This Analytic Story provides searches to help you identify various behaviors used by attackers to maintain persistent access to a Windows environment.

[Windows Privilege Escalation]
category = Adversary Tactics
creation_date = 2017-12-07
data_models = ["Application_State", "Authentication", "Endpoint", "Risk"]
description = Monitor for and investigate activities that may be associated with a Windows privilege-escalation attack, including unusual processes running on endpoints, modified registry keys, and more.
id = 644e22d3-598a-429c-a007-16fdb802cae5
version = 2.0
mappings = {"mitre_attack": ["Privilege Escalation", "Execution", "Exploitation for Privilege Escalation", "Accessibility Features", "Persistence"], "cis20": ["CIS 5", "CIS 2", "CIS 8"], "kill_chain_phases": ["Exploitation", "Actions on Objectives"], "nist": ["ID.AM", "PR.PT", "PR.DS", "DE.CM", "PR.AC"]}
modification_date = 2018-12-03
reference = ["https://attack.mitre.org/wiki/Privilege_Escalation"]
providing_technologies = ["Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Overwriting Accessibility Binaries - Rule", "ESCU - Registry Keys Used For Privilege Escalation - Rule", "ESCU - Uncommon Processes On Endpoint - Rule", "ESCU - Child Processes of Spoolsv.exe - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
narrative = Privilege escalation is a "land-and-expand" technique, wherein an adversary gains an initial foothold on a host and then exploits its weaknesses to increase his privileges. The motivation is simple: certain actions on a Windows machine--such as installing software--may require higher-level privileges than those the attacker initially acquired. By increasing his privilege level, the attacker can gain the control required to carry out his malicious ends. This Analytic Story provides searches to detect and investigate behaviors that attackers may use to elevate their privileges in your environment.

[Windows Service Abuse]
category = Malware
creation_date = 2017-11-02
data_models = ["Application_State", "Authentication", "Risk"]
description = Windows services are often used by attackers for persistence and the ability to load drivers or otherwise interact with the Windows kernel. This Analytic Story helps you monitor your environment for indications that Windows services are being modified or created in a suspicious manner.
id = 6dbd810e-f66d-414b-8dfc-e46de55cbfe2
version = 3.0
mappings = {"mitre_attack": ["New Service", "Modify Existing Service", "Disabling Security Tools", "Privilege Escalation", "Defense Evasion", "Execution", "Persistence"], "cis20": ["CIS 5", "CIS 2", "CIS 3", "CIS 8", "CIS 9"], "kill_chain_phases": ["Actions on Objectives", "Installation"], "nist": ["ID.AM", "PR.DS", "PR.IP", "PR.PT", "PR.AC", "PR.AT", "DE.CM", "DE.AE"]}
modification_date = 2018-07-22
reference = ["https://attack.mitre.org/wiki/Technique/T1050", "https://attack.mitre.org/wiki/Technique/T1031"]
providing_technologies = ["Carbon Black Response", "CrowdStrike Falcon", "Linux", "Microsoft Windows", "Splunk Enterprise Security", "Sysmon", "Tanium", "Ziften", "macOS"]
detection_searches = ["ESCU - Sc.exe Manipulating Windows Services - Rule", "ESCU - Reg.exe Manipulating Windows Services Registry Keys - Rule", "ESCU - First Time Seen Running Windows Service - Rule"]
investigative_searches = ["ESCU - Get Process Info", "ESCU - Get Parent Process Info"]
contextual_searches = ["ESCU - Get Notable Info", "ESCU - Get Notable History", "ESCU - Get User Information from Identity Table", "ESCU - Get Authentication Logs For Endpoint", "ESCU - Get Risk Modifiers For User", "ESCU - Get Risk Modifiers For Endpoint"]
support_searches = ["ESCU - Previously Seen Running Windows Services"]
narrative = The Windows operating system uses a services architecture to allow for running code in the background, similar to a UNIX daemon. Attackers will often leverage Windows services for persistence, hiding in plain sight, seeking the ability to run privileged code that can interact with the kernel. In many cases, attackers will create a new service to host their malicious code. Attackers have also been observed modifying unnecessary or unused services to point to their own code, as opposed to what was intended. In these cases, attackers often use tools to create or modify services in ways that are not typical for most environments, providing opportunities for detection.

