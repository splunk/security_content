[
    {
        "name": "Attempted Credential Dump From Registry via Reg exe",
        "id": "e9fb4a59-c5fb-440a-9f24-191fbc6b2911",
        "version": 6,
        "date": "2021-09-16",
        "author": "Patrick Bareiss, Splunk",
        "type": "TTP",
        "datamodel": [
            "Endpoint"
        ],
        "description": "Monitor for execution of reg.exe with parameters specifying an export of keys that contain hashed credentials that attackers may try to crack offline.",
        "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_reg` OR `process_cmd` Processes.process=*save* (Processes.process=*HKEY_LOCAL_MACHINE\\\\Security* OR Processes.process=*HKEY_LOCAL_MACHINE\\\\SAM* OR Processes.process=*HKEY_LOCAL_MACHINE\\\\System* OR Processes.process=*HKLM\\\\Security* OR Processes.process=*HKLM\\\\System* OR Processes.process=*HKLM\\\\SAM*) by Processes.dest Processes.user Processes.parent_process Processes.process_name Processes.original_file_name Processes.process Processes.process_id Processes.parent_process_id | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `attempted_credential_dump_from_registry_via_reg_exe_filter`",
        "how_to_implement": "To successfully implement this search you need to be ingesting information on process that include the name of the process responsible for the changes from your endpoints into the `Endpoint` datamodel in the `Processes` node. In addition, confirm the latest CIM App 4.20 or higher is installed and the latest TA for the endpoint product.",
        "known_false_positives": "None identified.",
        "references": [
            "https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1003.002/T1003.002.md#atomic-test-1---registry-dump-of-sam-creds-and-secrets"
        ],
        "tags": {
            "name": "Attempted Credential Dump From Registry via Reg exe",
            "analytic_story": [
                "Credential Dumping",
                "DarkSide Ransomware"
            ],
            "asset_type": "Endpoint",
            "automated_detection_testing": "passed",
            "cis20": [
                "CIS 3",
                "CIS 5",
                "CIS 16"
            ],
            "confidence": 100,
            "context": [
                "Source:Endpoint",
                "Stage:Credential Access"
            ],
            "dataset": [
                "https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1003.002/atomic_red_team/windows-sysmon.log"
            ],
            "impact": 90,
            "kill_chain_phases": [
                "Actions on Objectives"
            ],
            "message": "An instance of $parent_process_name$ spawning $process_name$ was identified on endpoint $dest$ by user $user$ attempting to export the registry keys.",
            "mitre_attack_id": [
                "T1003.002",
                "T1003"
            ],
            "nist": [
                "DE.CM"
            ],
            "observable": [
                {
                    "name": "user",
                    "type": "User",
                    "role": [
                        "Victim"
                    ]
                },
                {
                    "name": "dest",
                    "type": "Hostname",
                    "role": [
                        "Victim"
                    ]
                },
                {
                    "name": "parent_process_name",
                    "type": "Process",
                    "role": [
                        "Parent Process"
                    ]
                },
                {
                    "name": "process_name",
                    "type": "Process",
                    "role": [
                        "Child Process"
                    ]
                }
            ],
            "product": [
                "Splunk Enterprise",
                "Splunk Enterprise Security",
                "Splunk Cloud"
            ],
            "required_fields": [
                "_time",
                "Processes.dest",
                "Processes.user",
                "Processes.parent_process_name",
                "Processes.parent_process",
                "Processes.original_file_name",
                "Processes.process_name",
                "Processes.process",
                "Processes.process_id",
                "Processes.parent_process_path",
                "Processes.process_path",
                "Processes.parent_process_id"
            ],
            "risk_score": 90,
            "security_domain": "endpoint",
            "risk_severity": "high",
            "mitre_attack_enrichments": [
                {
                    "mitre_attack_id": "T1003.002",
                    "mitre_attack_technique": "Security Account Manager",
                    "mitre_attack_tactics": [
                        "Credential Access"
                    ],
                    "mitre_attack_groups": [
                        "Dragonfly 2.0",
                        "GALLIUM",
                        "Ke3chang",
                        "Night Dragon",
                        "Threat Group-3390",
                        "Wizard Spider",
                        "menuPass"
                    ]
                },
                {
                    "mitre_attack_id": "T1003",
                    "mitre_attack_technique": "OS Credential Dumping",
                    "mitre_attack_tactics": [
                        "Credential Access"
                    ],
                    "mitre_attack_groups": [
                        "APT28",
                        "APT32",
                        "APT39",
                        "Axiom",
                        "Frankenstein",
                        "Leviathan",
                        "Poseidon Group",
                        "Sowbug",
                        "Suckfly",
                        "Tonto Team"
                    ]
                }
            ]
        },
        "macros": [
            {
                "name": "process_reg",
                "definition": "(Processes.process_name=reg.exe OR Processes.original_file_name=reg.exe)",
                "description": "Matches the process with its original file name, data for this macro came from https://strontic.github.io/"
            },
            {
                "name": "attempted_credential_dump_from_registry_via_reg_exe_filter",
                "definition": "search *",
                "description": "Update this macro to limit the output results to filter out false positives."
            }
        ],
        "lookups": [],
        "file_path": "/Users/pbareib/Documents/Projects/security_content/bin/contentctl_project/contentctl_infrastructure/tests/adapter/../builder/test_data/detection/valid.yml",
        "source": "detection"
    }
]