name: Potential Pass the Token or Hash Observed by an Event Collecting Device
id: 1058ba3e-a698-49bc-a1e5-7cedece4ea87
version: 2
description: This detection identifies potential Pass the Token or Pass the Hash credential
  stealing. We detect the main side effect of these attacks, which is a transition
  from the dominant Kerberos logins to rare NTLM logins for a given user, as reported
  by an event-collecting device (i.e., a specific domain controller or an endpoint
  destination).
search: '| from read_ssa_enriched_events()

  | eval timestamp=parse_long(ucast(map_get(input_event, "_time"), "string", null)),
  dest_user=ucast(map_get(input_event, "dest_user"), "string", null), dest_user_id=ucast(map_get(input_event,
  "dest_user_id"), "string", null), origin_device_id=ucast(map_get(input_event, "origin_device_id"),
  "string", null), signature_id=   lower(ucast(map_get(input_event, "signature_id"),
  "string", null)), authentication_method=  lower(ucast(map_get(input_event, "authentication_method"),
  "string", null)), event_id=ucast(map_get(input_event, "event_id"), "string", null)
  | where signature_id = "4624" AND (authentication_method="ntlmssp" OR authentication_method="kerberos")
  AND dest_user_id != null AND origin_device_id != null

  | eval isKerberos=if(authentication_method == "kerberos", 1, 0), isNtlm=if(authentication_method
  == "ntlmssp", 1, 0), timeNTLM=if(isNtlm > 0, timestamp, null)

  | stats sum(isKerberos) as totalKerberos, sum(isNtlm)     as totalNtlm, min(timestamp)  as
  startTime, min(timeNTLM)   as startNTLMTime, max(timestamp)  as endTime, max(timeNTLM)   as
  endNTLMTime by dest_user_id, dest_user, origin_device_id, span(timestamp, 86400s)

  | where NOT dest_user="-" AND totalKerberos > 0 AND totalNtlm > 0 AND endTime -
  startTime > 1800000 AND (totalKerberos > 10 * totalNtlm AND totalKerberos > 50)  AND
  (endTime - startTime) > 3 * (endNTLMTime - startNTLMTime)

  | eval body=create_map("category_id", 101, "class_id", 101000, "detection_start_time", timestamp, 
  "detection_end_time", timestamp, "device_entities", [create_map("uid", ucast(map_get(input_event, "dest_device_id"), "string", null), "type_id", 0)], 
  "disposition_id", 1, "end_time", timestamp, "event_id", 10100001, "event_time", strftime(timestamp, "%Y-%m-%dT%H:%M:%S.%6QZ", "%Z"), 
  "finding", create_map("confidence", 80, "confidence_id", 3, 
  "context_ids", [11, 10, 46, 48], "impact", 80, "impact_id", 5,
  "kill_chain_phase", "Exploitation", "kill_chain_phase_id", 4, 
  "risk_level", "High", "risk_level_id", 3, "risk_score", 64, 
  "type_id", 1, "ref_event_uid", event_id), "message", "Potential lateral movement and credential stealing via Pass the Token or Pass the Hash techniques. Operation is performed via credentials of the account $dest_user_id$ and observed by the logging device $origin_device_id$", 
  "metadata", create_map("log_name", "Authentication", "version", "1.0.0"), 
  "observables", [create_map("name", "dest_user", "role_ids", [1], "type_id", 6, "value", dest_user)], 
  "origin", create_map("product", create_map("name", "Splunk Behavioral Analytics")), 
  "rule", create_map("name", "Potential Pass the Token or Hash Observed by an Event Collecting Device"), "start_time", timestamp, "time", timestamp,
  "user_entities", [create_map("uid", ucast(map_get(input_event, "dest_user_id"),"string", null))]) | into write_ssa_finding_events();'
how_to_implement: You must be ingesting Windows Security logs from devices of interest
  - at least from domain controllers. Please make sure that event ID 4624 is being
  logged.
known_false_positives: Environments in which NTLM is used extremely rarely and for
  benign purposes (such as a rare use of SMB shares).
references:
- https://attack.mitre.org/techniques/T1550/002/
- https://www.offensive-security.com/metasploit-unleashed/psexec-pass-hash/
tags:
  analytic_story:
  - Active Directory Lateral Movement
  cis20:
  - CIS 16
  - CIS 20
  kill_chain_phases:
  - Exploitation
  mitre_attack_id:
  - T1550
  - T1550.002
  nist:
  - PR.PT
  - PR.AT
  - PR.AC
  - PR.IP
  required_fields:
  - _time
  - signature_id
  - dest_user
  - dest_user_id
  - origin_device_id
  - authentication_method
  risk_score: 64
  security_domain: endpoint
  risk_severity: medium
test:
  name: Potential Pass the Token or Hash Observed by an Event Collecting Device Unit
    Test
  tests:
  - name: Potential Pass the Token or Hash Observed by an Event Collecting Device
    file: endpoint/ssa___ptt_pth_kerb_ntlm_origin_device.yml
    pass_condition: '@count_gt(0)'
    attack_data:
    - file_name: ptt_pth_kerb_ntlm_anon_DC_dataset.log
      data: https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1550.002/extracts_from_real_data/ptt_pth_kerb_ntlm_anon_DC_dataset.log
      source: WinEventLog:Security
