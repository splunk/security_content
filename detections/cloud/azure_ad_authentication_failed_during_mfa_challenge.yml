name: Azure AD Authentication Failed During MFA Challenge
id: e62c9c2e-bf51-4719-906c-3074618fcc1c
version: 1
date: '2022-07-14'
author: Mauricio Velazco, Splunk
type: TTP
datamodel: []
description: 'The following analytic identifies an authentication attempt event against an Azure AD tenant that fails during the Multi Factor Authentication challenge. This behavior may represent an adversary
  trying to authenticate with compromised credentials. In some cases, adversaries may continuously repeat login attempts in order to bombard users with MFA push notifications, SMS messages,
  and phone calls, potentially resulting in the user finally accepting the authentication request.'
search: ' `azuread` body.category=SignInLogs body.properties.status.errorCode=500121
  | rename body.properties.* as *
  | stats values(userPrincipalName) by _time, ipAddress, status.additionalDetails, appDisplayName, userAgent
  | `azure_ad_authentication_failed_during_mfa_challenge_filter`'
how_to_implement: You must install the latest version of  Splunk Add-on for Microsoft Cloud Services from  Splunkbase(https://splunkbase.splunk.com/app/3110/#/details). You must be ingesting Azure Active Directory events into your Splunk environment. You must be ingesting Azure Active Directory events in your Splunk environment. Specifically, this analytic leverages the RiskyUsers and UserRiskEvents
  log category.
known_false_positives: Legitimate users may miss to reply the MFA challenge within the time window or deny it by mistake.
references:
- https://attack.mitre.org/techniques/T1621/ 
- https://attack.mitre.org/techniques/T1078/004/
- https://docs.microsoft.com/en-us/azure/active-directory/authentication/concept-mfa-howitworks
tags:
  analytic_story:
  - Azure Active Directory Account Takeover
  asset_type: Azure Active Directory
  cis20:
  - CIS 3
  - CIS 5
  - CIS 16
  confidence: 90
  context:
  - Source:Cloud Data
  - Stage:Initial Access
  dataset:
  - https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1621/azuread/azure-audit.log
  impact: 60
  kill_chain_phases:
  - Exploitation
  message: User $body.properties.userPrincipalName$ failed to pass MFA challenge
  mitre_attack_id:
  - T1078
  - T1078.004
  - T1621
  nist:
  - DE.CM
  observable:
  - name: userPrincipalName
    type: User
    role:
    - Victim
  - name: ipAddress
    type: IP Address
    role:
    - Attacker
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - body.category
  - body.properties.status.errorCode
  - body.properties.userPrincipalName
  - body.properties.ipAddress
  - body.properties.status.additionalDetails
  - body.properties.appDisplayName
  - body.properties.userAgent
  risk_score: 54
  security_domain: identity
