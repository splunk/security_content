name: Unusual Number of Computer Service Tickets Requested
id: ac3b81c0-52f4-11ec-ac44-acde48001122
version: 1
date: '2021-12-01'
author: Mauricio Velazco, Splunk
type: Hunting
datamodel: []
description: 'The following hunting analytic leverages Event ID 4769, `A Kerberos
  service ticket was requested`, to identify an unusual number of computer service
  ticket requests from one source. When a domain joined endpoint connects to a remote
  endpoint, it first will request a Kerberos Ticket with the computer name as the
  Service Name. An endpoint requesting a large number of computer service tickets
  for different endpoints could represent malicious behavior like lateral movement,
  malware staging, reconnaissance, etc.\

  The detection calculates the standard deviation for each host and leverages the
  3-sigma statistical rule to identify an unusual number of service requests. To customize
  this analytic, users can try different combinations of the `bucket` span time,  the
  calculation of the `upperBound` field as well as the Outlier calculation. This logic
  can be used for real time security monitoring as well as threat hunting exercises.\'
search: ' `wineventlog_security` EventCode=4769 Service_Name="*$" Account_Name!="*$*"
  | bucket span=2m _time | stats dc(Service_Name) AS unique_targets values(Service_Name)
  as host_targets by _time, Client_Address, Account_Name | eventstats avg(unique_targets)
  as comp_avg , stdev(unique_targets) as comp_std by Client_Address, Account_Name
  | eval upperBound=(comp_avg+comp_std*3) | eval isOutlier=if(unique_targets >10 and
  unique_targets >= upperBound, 1, 0) | `unusual_number_of_computer_service_tickets_requested_filter`'
how_to_implement: To successfully implement this search, you need to be ingesting
  Domain Controller and Kerberos events. The Advanced Security Audit policy setting
  `Audit Kerberos Authentication Service` within `Account Logon` needs to be enabled.
known_false_positives: An single endpoint requesting a large number of computer service
  tickets is not common behavior. Possible false positive scenarios include but are
  not limited to vulnerability scanners, administration systeams and missconfigured
  systems.
references:
- https://attack.mitre.org/techniques/T1078/
tags:
  analytic_story:
  - Active Directory Lateral Movement
  asset_type: Endpoint
  confidence: 60
  context:
  - Source:Endpoint
  - Stage:Lateral Movement
  impact: 70
  kill_chain_phases:
  - Exploitation
  message: ''
  mitre_attack_id:
  - T1078
  observable:
  - name: Client_Address
    type: Endpoint
    role:
    - Victim
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - EventCode
  - Ticket_Options
  - Ticket_Encryption_Type
  - dest
  - service
  - service_id
  risk_score: 42
  security_domain: endpoint
