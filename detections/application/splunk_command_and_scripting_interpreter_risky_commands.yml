name: Splunk Command and Scripting Interpreter Risky Commands
id: 1cf58ae1-9177-40b8-a26c-8966040f11ae
version: 1
date: '2022-05-23'
author: Michael Haag, Splunk
type: Hunting
datamodel:
- Endpoint
description: 'The Splunk platform contains built-in search processing language (SPL) safeguards to warn you when you are about to unknowingly run a search that contains commands that might be a security risk. This warning appears when you click a link or type a URL that loads a search that contains risky commands. The warning does not appear when you create ad hoc searches. This warning alerts you to the possibility of unauthorized actions by a malicious user. Unauthorized actions include -

1. Copying or transferring data (data exfiltration) \

1. Deleting data \

1. Overwriting data \

A possible scenario when this might occur is when a malicious person creates a search that includes commands that exfiltrate or damage data. The malicious person then sends an unsuspecting user a link to the search. The URL contains a query string (q) and a search identifier (sid), but the sid is not valid. The malicious person hopes the user will use the link and the search will run.'
search: '| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Splunk_Audit.Search_Activity where Search_Activity.search IN ("*runshellscript*", "*collect*","*delete*", "*fit*", "*outputcsv*", "*outputlookup*", "*run*", "*script*", "*sendalert*", "*sendemail*", "*tscollect*")
  by Search_Activity.search Search_Activity.info Search_Activity.total_run_time Search_Activity.user Search_Activity.savedsearch_name Search_Activity.search_type
  | `drop_dm_object_name(Splunk_Audit)` 
  | `security_content_ctime(firstTime)`
  | `security_content_ctime(lastTime)`
  | `splunk_command_and_scripting_interpreter_risky_commands_filter`'
how_to_implement: To successfully implement this search acceleration is recommended against the Search_Activity datamodel that runs against the splunk _audit index. 
known_false_positives: False positives will be present until properly filtered by Username, search name, and so forth. 
references:
- https://docs.splunk.com/Documentation/Splunk/latest/Security/SPLsafeguards#Commands_that_trigger_the_warning
tags:
  analytic_story:
  - Splunk Vulnerabilities
  asset_type: Web Server
  cis20:
  - CIS 3
  - CIS 5
  - CIS 16
  confidence: 40
  context:
  - Source:Endpoint
  dataset:
  - UPDATE_DATASET_URL
  impact: 50
  kill_chain_phases:
  - Actions on Objectives
  message: A risky Splunk command has ran by $user$ and should be reviewed.
  mitre_attack_id:
  - T1213
  nist:
  - DE.CM
  observable:
  - name: user
    type: User
    role:
    - Victim
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - Search_Activity.search 
  - Search_Activity.info
  - Search_Activity.total_run_time 
  - Search_Activity.user 
  - Search_Activity.savedsearch_name 
  - Search_Activity.search_type
  risk_score: 20
  security_domain: audit