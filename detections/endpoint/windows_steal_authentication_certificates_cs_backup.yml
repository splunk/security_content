name: Windows Steal Authentication Certificates CS Backup
id: a2f4cc7f-6503-4078-b206-f83a29f408a7
version: 2
date: '2024-05-11'
author: Michael Haag, Splunk
status: production
type: Anomaly
description: The following analytic identifies the backup of the Active Directory
  Certificate Services (AD CS) store, detected via Event ID 4876. This event is logged
  when a backup is performed using the CertSrv.msc UI or the CertUtil.exe -BackupDB
  command. Monitoring this activity is crucial as unauthorized backups can indicate
  an attempt to steal authentication certificates, which are critical for secure communications.
  If confirmed malicious, this activity could allow an attacker to impersonate users,
  escalate privileges, or access sensitive information, severely compromising the
  security of the environment.
data_source:
- Windows Event Log Security 4876
search: '`wineventlog_security` EventCode=4876| stats count min(_time) as firstTime
  max(_time) as lastTime by dest, name, action, Caller_Domain ,Caller_User_Name |
  `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_steal_authentication_certificates_cs_backup_filter`'
how_to_implement: To implement this analytic, enhanced Audit Logging must be enabled
  on AD CS and within Group Policy Management for CS server. See Page 128 of first
  reference.
known_false_positives: False positives will be generated based on normal certificate
  store backups. Leave enabled to generate Risk, as this is meant to be an anomaly
  analytic. If CS backups are not normal, enable as TTP.
references:
- https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf
tags:
  analytic_story:
  - Windows Certificate Services
  asset_type: Endpoint
  confidence: 80
  impact: 50
  message: The Active Directory Certiciate Services was backed up on $dest$.
  mitre_attack_id:
  - T1649
  observable:
  - name: dest
    type: Hostname
    role:
    - Victim
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - dest
  - name
  - action
  - Caller_Domain
  - Caller_User_Name
  risk_score: 40
  security_domain: endpoint
tests:
- name: True Positive Test
  attack_data:
  - data: 
      https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1649/atomic_red_team/4876_windows-security.log
    source: XmlWinEventLog:Security
    sourcetype: XmlWinEventLog
    update_timestamp: true
