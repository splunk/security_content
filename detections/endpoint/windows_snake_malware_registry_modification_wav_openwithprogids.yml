name: Windows Snake Malware Registry Modification wav OpenWithProgIds
id: 13cf8b79-805d-443c-bf52-f55bd7610dfd
version: 2
date: '2024-05-13'
author: Michael Haag, Splunk
status: production
type: TTP
data_source:
- Sysmon EventID 12 
- Sysmon EventID 13
description: The following analytic identifies modifications to the registry path
  .wav\\OpenWithProgIds, associated with the Snake Malware campaign. It leverages
  data from the Endpoint.Registry datamodel to detect changes in this specific registry
  location. This activity is significant because Snake's WerFault.exe uses this registry
  path to decrypt an encrypted blob containing critical components like the AES key,
  IV, and paths for its kernel driver and loader. If confirmed malicious, this could
  allow the attacker to load and execute Snake's kernel driver, leading to potential
  system compromise and persistent access.
search: '| tstats `security_content_summariesonly` count values(Registry.registry_key_name)
  as registry_key_name values(Registry.registry_path) as registry_path min(_time)
  as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path="*\\.wav\\OpenWithProgIds\\*"  by
  Registry.dest  Registry.user Registry.registry_path Registry.registry_key_name Registry.registry_value_name
  | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)`
  | `windows_snake_malware_registry_modification_wav_openwithprogids_filter`'
how_to_implement: To successfully implement this search you need to be ingesting information
  on process that include the name of the process responsible for the changes from
  your endpoints into the `Endpoint` datamodel in the `Registry` node. In addition,
  confirm the latest CIM App 4.20 or higher is installed and the latest TA for the
  endpoint product.
known_false_positives: False positives may be present and will require tuning based
  on program Ids in large organizations.
references:
- https://media.defense.gov/2023/May/09/2003218554/-1/-1/0/JOINT_CSA_HUNTING_RU_INTEL_SNAKE_MALWARE_20230509.PDF
tags:
  analytic_story:
  - Snake Malware
  asset_type: Endpoint
  atomic_guid:
  - 8318ad20-0488-4a64-98f4-72525a012f6b
  confidence: 50
  impact: 50
  message: A registry modification related to Snake Malware has been identified on
    $dest$.
  mitre_attack_id:
  - T1112
  observable:
  - name: dest
    type: Hostname
    role:
    - Victim
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - Registry.dest
  - Registry.user
  - Registry.registry_path
  - Registry.registry_key_name
  - Registry.registry_value_name
  security_domain: endpoint
tests:
- name: True Positive Test
  attack_data:
  - data: 
      https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/malware/snakemalware/snake_malware_regblob-windows-sysmon.log
    source: XmlWinEventLog:Microsoft-Windows-Sysmon/Operational
    sourcetype: xmlwineventlog
