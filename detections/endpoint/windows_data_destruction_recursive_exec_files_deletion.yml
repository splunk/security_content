name: Windows Data Destruction Recursive Exec Files Deletion
id: 3596a799-6320-4a2f-8772-a9e98ddb2960
version: 2
date: '2023-03-05'
author: Teoderick Contreras, Splunk, Steven Dick
status: production
type: TTP
description: This analytic identifies a suspicious process that is recursively deleting
  files on a compromised host. This behavior has been observed in several types of destructive malware,
  such as CaddyWiper, DoubleZero, and SwiftSlicer, which delete or overwrite
  files with randomly generated strings to make recovery impossible. Additionally, this analytic can
  detect potential recursive file writes across multiple files using Sysmon Event
  23 or 26. Sysmon considers a file as deleted as soon as it is overwritten.
  This analytic serves as a strong indicator of potential destructive malware activity
  on a host machine or the uninstallation of a large software application.
data_source:
- Sysmon Event ID 23
- Sysmon Event ID 26
search: '`sysmon` EventCode IN ("23","26") TargetFilename IN ("*.exe", "*.sys", "*.dll") 
  | bin _time span=2m 
  | stats count, values(TargetFilename) as deleted_files, min(_time) as firstTime, max(_time) as lastTime by user, dest, signature, signature_id, Image, process_name, process_guid
  | rename Image as process
  | where count >=500 
  | `security_content_ctime(firstTime)` 
  | `security_content_ctime(lastTime)` 
  | `windows_data_destruction_recursive_exec_files_deletion_filter`'
how_to_implement: To successfully implement this search, you need to ingest logs that include the process name, TargetFilename, and ProcessID executions from your endpoints. If you are using Sysmon, ensure you have at least version 2.0 of the Sysmon TA installed.
known_false_positives: The uninstallation of a large software application or the use of cleanmgr.exe may trigger this detection. A filter is necessary to reduce false positives.
references:
- https://www.welivesecurity.com/2023/01/27/swiftslicer-new-destructive-wiper-malware-ukraine/
tags:
  analytic_story:
  - Swift Slicer
  - Data Destruction
  asset_type: Endpoint
  confidence: 80
  impact: 80
  message: The process $process_name$ has removed a significant quantity of executable files, totaling [$count$], from the destination $dest$.
  mitre_attack_id:
  - T1485
  observable:
  - name: user
    type: User
    role:
    - Victim
  - name: dest
    type: Endpoint
    role:
    - Victim
  - name: deleted_files
    type: File Name
    role:
    - Attacker
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - Image
  - TargetFilename
  - dest
  - user
  - signature_id
  - process_name
  - process_guid
  risk_score: 64
  security_domain: endpoint
tests:
- name: True Positive Test
  attack_data:
  - data: https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/malware/swift_slicer/sysmon.log
    source: XmlWinEventLog:Microsoft-Windows-Sysmon/Operational
    sourcetype: xmlwineventlog