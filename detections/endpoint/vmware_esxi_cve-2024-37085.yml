name: VMWare ESXi CVE-2024-37085
id: e8c08f80-c382-4f24-8d95-1a8f4e358eba
version: 1
date: "2024-07-29"
author: Brandon Sternfield, Optiv + ClearShark
type: TTP
status: experimental
data_source:
- Windows Event Log Security 4726
- Windows Event Log Security 4731
- Windows Event Log Security 4744
- Windows Event Log Security 4749
- Windows Event Log Security 4754
- Windows Event Log Security 4759
- Windows Event Log Security 4783
- Windows Event Log Security 4790
description: If someone creates a security group in AD called 'ESX Admins'
  and puts themselves in it, VMWare ESXi will let them authenticate as admins
  automatically giving them full access. This detection looks for the creation
  of this group to alert upon.
search: '`wineventlog_security` PrivilegeList SidHistory
  SamAccountName TargetDomainName TargetUserName
  |  search EventCode IN (4727,4731,4744,4749,4754,4759,4783,4790)
  | eval object_category=case(
  EventCode=="4731", "Local Group (Security)",
  EventCode=="4744", "Local Group (Distribution)",
  EventCode=="4727", "Global Group (Security)",
  EventCode=="4749", "Global Group (Distribution)",
  EventCode=="4754", "Universal Group (Security)",
  EventCode=="4759", "Universal Group (Distribution)",
  EventCode=="4783", "Basic Application Group",
  EventCode=="4790", "LDAP Query Group")
  | search TargetUserName="ESX Admins"
  | eval _time = strptime(SystemTime, "'%Y-%m-%dT%H:%M:%S.%9Q%Z'")
  | table _time src_user object_category TargetUserName TargetSid dest result
  status
  | rename result AS change_type, TargetUserName AS object, TargetSid AS
  object_path | `vmware_esxi_cve-2024-37085_filter`'
how_to_implement: To successfully implement this search you need to be ingesting Windows Security Events from a Domain Controller in regards to Active Directory modifications. In addition, confirm
  the latest CIM App 4.20 or higher is installed and the latest TA''s are installed.
known_false_positives: None
references:
- https://nvd.nist.gov/vuln/detail/CVE-2024-37085
- https://www.rapid7.com/blog/post/2024/07/30/vmware-esxi-cve-2024-37085-targeted-in-ransomware-campaigns/%5C
tags:
  asset_type: Network
  confidence: 100
  cve:
  - CVE-2024-37085
  impact: 100
  message: CVE-2024-37085 Exploitation Detected on $dest$ by $src_user$.
  observable:
  - name: src_user
    type: User
    role:
    - Attacker
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - src_user
  - object_category
  - TargetUserName
  - TargetSid
  - dest
  - result
  - _time
  risk_score: 100
  security_domain: threat
