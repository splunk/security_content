name: Windows Service Created Within Public Path
id: 3abb2eda-4bb8-11ec-9ae4-3e22fbd008af
version: 3
date: '2024-05-15'
author: Mauricio Velazco, Splunk
status: production
type: TTP
description: The following analytic detects the creation of a Windows Service with
  its binary path located in public directories using Windows Event ID 7045. This
  detection leverages logs from the `wineventlog_system` data source, focusing on
  the `ImagePath` field to identify services installed outside standard system directories.
  This activity is significant as it may indicate the installation of a malicious
  service, often used by adversaries for lateral movement or remote code execution.
  If confirmed malicious, this could allow attackers to execute arbitrary code, maintain
  persistence, or further compromise the system.
data_source:
- Windows Event Log System 7045
search: '`wineventlog_system` EventCode=7045 ImagePath = "*.exe" NOT (ImagePath IN
  ("*:\\Windows\\*", "*:\\Program File*", "*:\\Programdata\\*", "*%systemroot%\\*"))
  | stats count min(_time) as firstTime max(_time) as lastTime by EventCode ImagePath
  ServiceName ServiceType StartType Computer UserID | rename Computer as dest | `security_content_ctime(firstTime)`
  | `security_content_ctime(lastTime)` | `windows_service_created_within_public_path_filter`'
how_to_implement: To successfully implement this search, you need to be ingesting
  logs with the Service name, Service File Name Service Start type, and Service Type
  from your endpoints.
known_false_positives: Legitimate applications may install services with uncommon
  services paths.
references:
- https://docs.microsoft.com/en-us/windows/win32/services/service-control-manager
- https://pentestlab.blog/2020/07/21/lateral-movement-services/
tags:
  analytic_story:
  - Active Directory Lateral Movement
  - Snake Malware
  asset_type: Endpoint
  confidence: 60
  impact: 90
  message: A Windows Service $ServiceName$ with a public path was created on $dest$
  mitre_attack_id:
  - T1543
  - T1543.003
  observable:
  - name: ServiceName
    type: Other
    role:
    - Other
  - name: dest
    type: Endpoint
    role:
    - Victim
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - EventCode
  - Service_File_Name
  - Service_Type
  - _time
  - Service_Name
  - Service_Start_Type
  risk_score: 54
  security_domain: endpoint
tests:
- name: True Positive Test
  attack_data:
  - data: 
      https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1569.002/windows_service_created_with_suspicious_service_path/windows-xml.log
    source: XmlWinEventLog:System
    sourcetype: XmlWinEventLog
