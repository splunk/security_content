name: Detect Webshell Exploit Behavior
id: 22597426-6dbd-49bd-bcdc-4ec19857192f
version: 1
date: '2023-04-04'
author: Steven Dick
type: TTP
datamodel:
- Endpoint
description: This search is used to detect the abuse of web applications by adversaries. 
Adversaries may install a backdoor or script onto web servers by exploiting known 
vulnerabilities or misconfigruations. Web shells are used to establish persistent access 
to systems and provide a set of executable functions or a command-line interface on the 
system hosting the Web server.
search: '| tstats `summariesonly` count max(_time) as lastTime, min(_time) as firstTime from datamodel=Endpoint.Processes 
where (Processes.process_name IN ("arp.exe","at.exe","bash.exe","bitsadmin.exe","certutil.exe","cmd.exe","cscript.exe", 
"dsget.exe","dsquery.exe","find.exe","findstr.exe","fsutil.exe","hostname.exe","ipconfig.exe","ksh.exe","nbstat.exe",
"net.exe","net1.exe","netdom.exe","netsh.exe","netstat.exe","nltest.exe","nslookup.exe","ntdsutil.exe","pathping.exe",
"ping.exe","powershell.exe","pwsh.exe","qprocess.exe","query.exe","qwinsta.exe","reg.exe","rundll32.exe","sc.exe",
"scrcons.exe","schtasks.exe","sh.exe","systeminfo.exe","tasklist.exe","tracert.exe","ver.exe","vssadmin.exe",
"wevtutil.exe","whoami.exe","wmic.exe","wscript.exe","wusa.exe","zsh.exe") 
AND Processes.parent_process_name IN ("w3wp.exe", "http*.exe", "nginx*.exe", "php*.exe", "php-cgi*.exe","tomcat*.exe")) 
by Processes.dest,Processes.user,Processes.parent_process,Processes.parent_process_name,Processes.process,Processes.process_name
| `drop_dm_object_name("Processes")`
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `detect_webshell_exploit_behavior`'
how_to_implement: To successfully implement this search you need to be ingesting information
  on process that includes the full command line of the process being launched on
  your endpoints into the `Endpoint` datamodel in the `Processes` node. In addition,
  confirm the latest CIM App 4.20 or higher is installed and the latest TA for the
  endpoint product.
known_false_positives: Legitimate OS funcations called by vendor applications, baseline the enviroment and filter before enabling.
Recommend throttle by dest/process_name
references:
- https://attack.mitre.org/techniques/T1505/003/
- https://github.com/nsacyber/Mitigating-Web-Shells
- https://www.hackingarticles.in/multiple-ways-to-exploit-tomcat-manager/
tags:
  analytic_story:
  confidence: 80
  context:
  - Source:Endpoint
  - Stage:Persistence
  dataset:
  - https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1505.003/generic_webshell_exploit/generic_webshell_exploit.log
  impact: 100
  kill_chain_phases:
  - Persistence
  message: Webshell Exploit Behavior - $parent_process_name$ spawned $process_name$ on $dest$.
  mitre_attack_id:
  - T1505
  - T1505.003
  observable:
  - name: user
    type: User
    role:
    - Victim
  - name: dest
    type: Endpoint
    role:
    - Victim
  - name: process_name
    type: Process
    role:
    - Attacker
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - Processes.dest
  - Processes.user
  - Processes.parent_process
  - Processes.parent_process_name
  - Processes.process
  - Processes.process_name
  risk_score: 80
  security_domain: endpoint
  supported_tas:
  - Splunk_TA_microsoft_sysmon
  asset_type: Endpoint