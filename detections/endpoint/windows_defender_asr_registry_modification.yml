name: Windows Defender ASR Registry Modification
id: 6a1b6cbe-6612-44c3-92b9-1a1bd77412eb
version: 3
date: '2024-08-14'
author: Michael Haag, Splunk
status: production
type: Hunting
data_source:
- Windows Event Log Defender 5007
description: 'The following analytic detects modifications to Windows Defender Attack
  Surface Reduction (ASR) registry settings. It leverages Windows Defender Operational
  logs, specifically EventCode 5007, to identify changes in ASR rules. This activity
  is significant because ASR rules are designed to block actions commonly used by
  malware to exploit systems. Unauthorized modifications to these settings could indicate
  an attempt to weaken system defenses. If confirmed malicious, this could allow an
  attacker to bypass security measures, leading to potential system compromise and
  data breaches.'
search: '`ms_defender` EventCode IN (5007) 
  | rex field=New_Value "0x(?<New_Registry_Value>\\d+)$"
  | rex field=Old_Value "0x(?<Old_Registry_Value>\\d+)$"
  | rex field=New_Value "Rules\\\\(?<ASR_ID>[A-Fa-f0-9\\-]+)\\s*="
  | eval New_Registry_Value=case(New_Registry_Value=="0", "Disabled", New_Registry_Value=="1", "Block", New_Registry_Value=="2", "Audit", New_Registry_Value=="6", "Warn")
  | eval Old_Registry_Value=case(Old_Registry_Value=="0", "Disabled", Old_Registry_Value=="1", "Block", Old_Registry_Value=="2", "Audit", Old_Registry_Value=="6", "Warn")
  | stats count min(_time) as firstTime max(_time) as lastTime by host, New_Value, Old_Value, Old_Registry_Value, New_Registry_Value, ASR_ID
  | lookup asr_rules ID AS ASR_ID OUTPUT ASR_Rule
  | `security_content_ctime(firstTime)`| rename host as dest | `security_content_ctime(lastTime)`
  | `windows_defender_asr_registry_modification_filter`'
how_to_implement: The following analytic requires collection of Windows Defender Operational
  logs in either XML or multi-line. To collect, setup a new input for the Windows
  Defender Operational logs. In addition, it does require a lookup that maps the ID
  to ASR Rule name.
known_false_positives: False positives are expected from legitimate applications generating
  events that are similar to those generated by malicious activity. For example, Event
  ID 5007 is generated when a process attempts to modify a registry key that is related
  to ASR rules. This can be triggered by legitimate applications that attempt to modify
  registry keys that are not blocked by ASR rules.
references:
- https://asrgen.streamlit.app/
tags:
  analytic_story:
  - Windows Attack Surface Reduction
  asset_type: Endpoint
  atomic_guid: []
  confidence: 100
  impact: 50
  message: ASR registry modification event, $ASR_Rule$, was triggered on $dest$.
  mitre_attack_id:
  - T1112
  observable:
  - name: dest
    type: Endpoint
    role:
    - Victim
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - host
  - New_Value
  - Old_Value
  - Old_Registry_Value
  - New_Registry_Value
  - ASR_Rule
  security_domain: endpoint
tests:
- name: True Positive Test
  attack_data:
  - data: 
      https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1059/defender/asr_registry.log
    source: WinEventLog:Microsoft-Windows-Windows Defender/Operational
    sourcetype: xmlwineventlog
