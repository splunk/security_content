name: System Processes Run From Unexpected Locations
id: a34aae96-ccf8-4aef-952c-3ea21444444d
version: 5
date: '2020-02-04'
description: This search looks for system processes that normally run out of C:\Windows\System32\
  or C:\Windows\SysWOW64 that are not run from that location.  This can indicate a
  malicious process that is trying to hide as a legitimate process.
how_to_implement: To successfully implement this search you need to ingest details
  about process execution from your hosts. Specifically, this search requires the
  process name and the full path to the process executable.
type: ESCU
references: []
author: David Dorsey, Splunk
search: '| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
  as lastTime FROM datamodel=Endpoint.Processes where Processes.process_path !="C:\\Windows\\System32*"
  Processes.process_path !="C:\\Windows\\SysWOW64*" by Processes.user Processes.dest
  Processes.process_name Processes.process_id Processes.process_path Processes.parent_process_name
  Processes.process_hash| `drop_dm_object_name("Processes")` | `security_content_ctime(firstTime)`|
  `security_content_ctime(lastTime)`| `is_windows_system_file` | `system_processes_run_from_unexpected_locations_filter`'
known_false_positives: None identified
tags:
  analytics_story:
  - Suspicious Command-Line Executions
  - Unusual Processes
  - Ransomware
  mitre_attack_id:
  - T1036
  kill_chain_phases:
  - Actions on Objectives
  cis20:
  - CIS 8
  nist:
  - PR.PT
  - DE.CM
  security_domain: endpoint
  asset_type: Endpoint
